# Setup the host:
#   deploy climbeco -lclimbeco_host
#
# Update nginx config
#   deploy climbeco nginx
#
# Recreate the lxd container
#   deploy climbeco lxd
#
# Redeploy jupyterhub
#   deploy climbeco -lclimbeco climbeco_deploy

- hosts: climbeco_host
  become: true
  vars:
    climbeco_domain: climbeco.icos-cp.eu
    climbeco_port: 50524
  pre_tasks:
    - name: Create climbeco LXD configuration
      tags: profile
      lxd_profile:
        name: climbeco
        config:
          security.nesting: "true"
          limits.cpu: "4"
          limits.memory: "50GB"
        description: "Configuration for Climbeco"
        devices:
          root:
            path: /
            type: disk
            pool: climbeco
          data:
            path: /data
            source: /data
            type: disk
            recursive: "true"
  roles:
    - role: icos.lxd_host
      tags: lxd
      lxd_host_name: climbeco
      lxd_host_port: "{{ hostvars['climbeco'].ansible_port }}"
      lxd_host_profiles:
        - default
        - climbeco

    - role: icos.certbot2
      tags: cert
      certbot_name: climbeco
      certbot_domains:
        - "{{ climbeco_domain }}"

    - role: icos.nginxsite
      tags: nginx
      nginxsite_name: climbeco
      nginxsite_file: roles/icos.climbeco/templates/climbeco.conf


- hosts: climbeco
  roles:
    - role: icos.lxd_guest
      tags: guest

    - role: icos.docker
      tags: docker

    - role: icos.climbeco
      tags: climbeco
