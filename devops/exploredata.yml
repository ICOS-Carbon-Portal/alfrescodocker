# Setup the host
#   deploy exploredata -lexploredata_host
#
# Update the profile
#   deploy exploredata profile
#
# Recreate the lxd container
#   deploy exploredata lxd
- hosts: exploredata_host
  vars:
    lxd_host_ip: "{{ _lxd.addresses.eth0 | first }}"
  pre_tasks:
    - name: Create exploredata storage pool
      tags: pool
      # named ed for historical reasens
      shell: >-
        /snap/bin/lxc storage show ed > /dev/null 2>&1 ||
        /snap/bin/lxc storage create ed btrfs size=50GB
      register: _r
      changed_when:
        - '"Storage pool ed created" in _r.stdout'

    - name: Create the exploredata container
      lxd_container:
        name: exploredata
        state: started
        profiles:
          - default
          - ssh_root
        source:
          type: image
          mode: pull
          server: https://cloud-images.ubuntu.com/releases
          protocol: simplestreams
          alias: "18.04"
        config:
          security.nesting: "true"
          limits.cpu: "4"
          limits.memory: "50GB"
        devices:
          root:
            path: /
            type: disk
            pool: ed  # named ed for historical reasens
          data:
            path: /data
            source: /data
            type: disk
            recursive: "true"
        wait_for_ipv4_addresses: true
        wait_for_ipv4_interfaces: eth0
        timeout: 600
      register: _lxd

  roles:
    - role: icos.lxd_forward
      lxd_forward_ip: "{{ lxd_host_ip }}"
      lxd_forward_name: exploredata

    - role: icos.certbot2
      tags: cert
      vars:
        certbot_name: exploredata
        certbot_domains:
          - exploretest.icos-cp.eu
          - exploredata.icos-cp.eu

    - role: icos.nginxsite
      tags: nginx
      vars:
        nginxsite_name: exploredata-test
        nginxsite_file: roles/icos.exploredata/templates/exploredata-nginx.conf
        exploredata_name: test
        exploredata_port: 4567
        exploredata_host: "{{ lxd_host_ip }}"
        exploredata_domain: exploretest.icos-cp.eu

    - role: icos.nginxsite
      tags: nginx
      vars:
        nginxsite_name: exploredata-prod
        nginxsite_file: roles/icos.exploredata/templates/exploredata-nginx.conf
        exploredata_name: prod
        exploredata_port: 4566
        exploredata_host: "{{ lxd_host_ip }}"
        exploredata_domain: exploredata.icos-cp.eu


- hosts: exploredata
  vars_files:
    - vault.yml
  roles:
    - role: icos.lxd_guest
      tags: guest
      lxd_guest_ssh_keys: "{{ vault_exploredata_ssh_keys }}"

    - role: icos.docker
      tags: docker

    - role: icos.exploredata
      tags: exploredata
      exploredata_password: "{{ vault_exploredata_password }}"
