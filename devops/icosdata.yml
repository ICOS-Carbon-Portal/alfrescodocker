# Try to set up /data so that it looks the same on all our servers.
# The LXD "icosdata" profile will make the following paths available.
#
# Update LXD profile
#   deploy icosdata -lfsicos2* profile
#
# Update the bind-mounts on fsicos2
#   deploy icosdata -lfsicos2* bind
#
# /data/stiltweb              fsicos2:/disk/data/stiltweb
# /data/project               fsicos2:/disk/data/project
# /data/project/eurocom       fsicos:/disk/data/eurocom
# /data/project/interpolation fsicos:/disk/data/common/netcdf/gcp_models
# /data/stilt                 fsicos:/disk/data/STILT/RINGO/T1.3/STILT
# /data/obspack               fsicos:/disk/data/STILT/ObsPack
# /data/flexpart              fsicos:/disk/data/flexpart
#
# /opt/eurocom                fsicos:/disk/data/eurocom
# /opt/stiltdata              fsicos:/disk/data/STILT


- hosts: fsicos.lunarc.lu.se
  tasks:
    - name: Create /etc/exports.d directory
      file:
        path: "/etc/exports.d"
        state: directory

    - name: Add icosdata exports
      copy:
        dest: /etc/exports.d/icosdata.exports
        content: |
          /disk/data/STILT/RINGO/T1.3/STILT   {{ fsicos2_ip }}(ro)
          /disk/data/STILT/ObsPack            {{ fsicos2_ip }}(ro)
          /disk/data/flexpart                 {{ fsicos2_ip }}(ro)
          /disk/data/common/netcdf/gcp_models {{ fsicos2_ip }}(ro)
          /disk/data/eurocom		      {{ fsicos2_ip }}(ro)
      register: _exports

    - name: Reload NFS server
      service:
        name: nfs-server
        state: reloaded
      when: _exports.changed


- hosts: fsicos2.lunarc.lu.se
  tasks:
    - name: Create mount points
      tags: mkdir
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - /data/stilt
        - /data/obspack
        - /data/flexpart
        - /disk/data/project/interpolation
        - /disk/data/project/eurocom

    - name: Do bind-mount local data
      tags: bind
      mount:
        path: "{{ item.path }}"
        src:  "{{ item.src }}"
        fstype: none
        opts: "bind{{ item.opts | default('') }}"
        state: mounted
      loop:
        - path: /data/stiltweb
          src: /disk/data/stiltweb
          opts: ",ro"

        - path: /data/project
          src: /disk/data/project

        - path: /data/dataAppStorage
          src: /disk/data/dataAppStorage
          opts: ",ro"

    - name: Mount "{{ item.path }}" from fsicos1
      tags: nfs
      mount:
        path: "{{ item.path }}"
        src: "{{ item.src }}"
        fstype: nfs
        opts: ro
        state: mounted
      loop:
        - path: /data/stilt
          src: 194.47.223.133:/disk/data/STILT/RINGO/T1.3/STILT

        - path: /data/obspack
          src: 194.47.223.133:/disk/data/STILT/ObsPack

        - path: /data/flexpart
          src: 194.47.223.133:/disk/data/flexpart

        - path: /data/project/interpolation
          src: 194.47.223.133:/disk/data/common/netcdf/gcp_models

        - path: /data/project/eurocom
          src: 194.47.223.133:/disk/data/eurocom

    - name: Create LXD data profile
      tags: profile
      lxd_profile:
        name: icosdata
        description: "ICOS Data"
        devices:          old_eurocom:
            path: /opt/eurocom
            readonly: "true"
            source: /data/project/eurocom
            type: disk
          old_stilt:
            path: /opt/stiltdata
            readonly: "true"
            source: /disk/data/fsicos-stilt/
            type: disk

          dataAppStorage:
            path: /data/dataAppStorage
            source: /data/dataAppStorage
            type: disk
            readonly: "true"
          eurocom:
            path: /data/eurocom
            source: /data/eurocom
            type: disk
            readonly: "true"
          flexextract:
            path: /data/flexextract
            source: /data/flexextract
            type: disk
            readonly: "true"
          flexpart:
            path: /data/flexpart
            source: /data/flexpart
            type: disk
            readonly: "true"
          obspack:
            path: /data/obspack
            source: /data/obspack
            type: disk
            readonly: "true"
          stilt:
            path: /data/stilt
            source: /data/stilt
            type: disk
            readonly: "true"
          stiltweb:
            path: /data/stiltweb
            source: /data/stiltweb
            type: disk
            readonly: "true"

    - name: Create LXD project profile
      tags: profile
      lxd_profile:
        name: icosproject
        description: "ICOS Project Data"
        devices:
          project:
            path: /data/project
            source: /data/project
            type: disk
          # Even though eurocom and interpolation lives below /data/project,
          # they are mounted from fsicos1 using nfs and won't show up unless
          # explicitly mounted
          eurocom:
            path: /data/project/eurocom
            readonly: "true"
            source: /data/project/eurocom
            type: disk
          interpolation:
            path: /data/project/interpolation
            readonly: "true"
            source: /data/project/interpolation
            type: disk
