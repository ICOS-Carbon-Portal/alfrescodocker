# Try to set up /data so that it looks the same on all our servers.
# The LXD "icosdata" profile will make the following paths available.
#
# Update LXD profile
#   deploy icosdata -lfsicos2* profile
#
# Update the bind-mounts on fsicos2
#   deploy icosdata -lfsicos2* bind



# FSICOS 1

- hosts: fsicos.lunarc.lu.se
  handlers:
    - name: Reload NFS server
      service:
        name: nfs-server
        state: reloaded
  tasks:
    - name: Create /etc/exports.d directory
      tags: exports
      file:
        path: "/etc/exports.d"
        state: directory

    - name: Add icosdata exports
      tags: exports
      copy:
        dest: /etc/exports.d/icosdata.exports
        content: |
          /disk/data/STILT/RINGO/T1.3/STILT   fsicos*.lunarc.lu.se(ro)
          /disk/data/STILT/ObsPack            fsicos*.lunarc.lu.se(ro)
          /disk/data/common/netcdf/gcp_models fsicos*.lunarc.lu.se(ro)
          /disk/data/eurocom		      fsicos*.lunarc.lu.se(ro)
          /disk/data/flexpart		      fsicos*.lunarc.lu.se(ro)
      notify: Reload NFS server



# FSICOS2

- hosts: fsicos2.lunarc.lu.se
  handlers:
    - name: Reload NFS server
      service:
        name: nfs-server
        state: reloaded
  tasks:
    - name: Do bind-mount local data
      mount:
        path: "{{ item.path }}"
        src:  "{{ item.src }}"
        fstype: none
        opts: "bind{{ item.opts | default('') }}"
        state: mounted
      loop:
        - path: /data/stiltweb
          src: /disk/data/stiltweb
          opts: ",ro"

        - path: /data/project
          src: /disk/data/project

        - path: /data/dataAppStorage
          src: /disk/data/dataAppStorage
          opts: ",ro"

    - name: Create nfs mount points
      file:
        path: "{{ item }}"
        state: directory
      loop:
        - /data/stilt
        - /data/obspack
        - /data/flexpart
        - /disk/data/project/interpolation
        - /disk/data/project/eurocom
        - /share/fsicos3

    - name: Mount nfs data
      mount:
        path: "{{ item.path }}"
        src: "{{ item.src }}"
        fstype: nfs
        opts: "{{ item.opts | default('ro') }}"
        state: mounted
      loop:
        - path: /share/fsicos3
          src: fsicos3.lunarc.lu.se:/incoming
          opts: rw

        - path: /data/project/eurocom
          src: fsicos.lunarc.lu.se:/disk/data/eurocom

        - path: /data/obspack
          src: fsicos.lunarc.lu.se:/disk/data/STILT/ObsPack

        - path: /data/stilt
          src: fsicos.lunarc.lu.se:/disk/data/STILT/RINGO/T1.3/STILT

        - path: /data/flexpart
          src: fsicos.lunarc.lu.se:/disk/data/flexpart

        - path: /data/project/interpolation
          src: fsicos.lunarc.lu.se:/disk/data/common/netcdf/gcp_models

    - import_tasks: tasks/icosdata_profile.yml

    - name: Export data via nfs
      tags: export
      copy:
        dest: "/etc/exports.d/{{ item.name }}.exports"
        content: |
          {{ item.path }} fsicos*.lunarc.lu.se(ro)
      loop:
        - name: flexextract
          path: /data/flexextract
        - name: flexpart
          path: /disk/data/flexpart/meteo
        - name: dataAppStorage
          path: /disk/data/dataAppStorage
        - name: stiltweb
          path: /disk/data/stiltweb
      notify: Reload NFS server



# FSICOS3

- hosts: fsicos3.lunarc.lu.se
  handlers:
    - name: Reload NFS server
      service:
        name: nfs-server
        state: reloaded
  tasks:
    - name: Install nfs-kernel-server
      apt:
        name: nfs-kernel-server
        state: present

    - name: Create /incoming
      tags: incoming
      zfs:
        name: pool/incoming
        state: present
        extra_zfs_properties:
          mountpoint: /incoming

    - name: Create /etc/exports.d directory
      file:
        path: "/etc/exports.d"
        state: directory

    - name: Mount nfs data
      tags: nfs
      mount:
        src: "{{ item.src }}"
        path: "{{ item.path }}"
        state: mounted
        fstype: nfs
      loop:
        - path: /data/flexextract
          src: fsicos2.lunarc.lu.se:/data/flexextract

        - path: /data/flexpart/meteo
          src: fsicos2.lunarc.lu.se:/disk/data/flexpart/meteo

        - path: /data/dataAppStorage
          src: fsicos2.lunarc.lu.se:/disk/data/dataAppStorage

        - path: /data/stiltweb
          src: fsicos2.lunarc.lu.se:/disk/data/stiltweb

        - path: /data/obspack
          src: fsicos.lunarc.lu.se:/disk/data/STILT/ObsPack

        - path: /data/stilt
          src: fsicos.lunarc.lu.se:/disk/data/STILT/RINGO/T1.3/STILT

        - path: /data/project/interpolation
          src: fsicos.lunarc.lu.se:/disk/data/common/netcdf/gcp_models

    - import_tasks: tasks/icosdata_profile.yml

    - name: Export data via nfs
      tags: export
      copy:
        dest: "/etc/exports.d/{{ item.name }}.exports"
        content: |
          {{ item.path }} fsicos*.lunarc.lu.se({{ item.opts | default('ro') }})
      loop:
        - name: incoming
          path: /incoming
          opts: "rw,no_root_squash"
      notify: Reload NFS server
