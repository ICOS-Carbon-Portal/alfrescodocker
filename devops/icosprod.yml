# This ansible playbook will provision our production servers.

- import_playbook: setup.yml

- hosts: icosprod icosprod2
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.linux
      tags: linux
    - role: icos.docker
      tags: docker
    - role: icos.nginx
      tags: nginx
    - role: icos.java
      tags: java

- hosts: icosprod
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    # Higher level service-level roles.
    - role: icos.restheart
      tags: restheart
    - role: icos.cpauth
      tags: cpauth
    - role: icos.cpdata
      tags: cpdata
    - role: icos.doi
      tags: doi
    - role: icos.filedrop
      tags: filedrop
    - role: icos.kanboard
      tags: kanboard
    - role: icos.drupal
      tags: drupal
    - role: icos.mattermost
      tags: mattermost
    - role: icos.sitesaquanetform
      tags: sitesaquanetform
  tasks:
    - include_role: name=icos.pgrep
      vars:  { arg: "{{ item }}" }
      loop: "{{ pgrep_instances }}"
      tags: pgrep

- hosts: icosprod2
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.geoip
      tags: geoip
    - role: icos.rdflog
      tags: rdflog
    - role: icos.cpmeta
      tags: cpmeta
