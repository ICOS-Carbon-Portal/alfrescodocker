# This ansible playbook will provision our production servers.

- import_playbook: setup.yml

- hosts: icosprod
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    # Higher level service-level roles.
    - role: icos.restheart
      tags: restheart
    - role: icos.cpauth
      tags: cpauth
    - role: icos.cpmeta
      tags: cpmeta
    - role: icos.cpdata
      tags: cpdata
    - role: icos.doi
      tags: doi
    - role: icos.filedrop
      tags: filedrop
    - role: icos.kanboard
      tags: kanboard
    - role: icos.drupal
      tags: drupal
    - role: icos.mattermost
      tags: mattermost
    - role: icos.sitesaquanetform
      tags: sitesaquanetform
  tasks:
    - include_role:
        name: icos.certbot
      vars:
        - certbot_domains: "{{item.certbot_domains}}"
        - nginx_conf_name: "{{item.nginx_conf_name}}"
      loop:
        - { certbot_domains: [eurocom.icos-cp.eu], nginx_conf_name: eurocom }
        - { certbot_domains: [jupyter.icos-cp.eu], nginx_conf_name: jupyter }
        - { certbot_domains: [repo.icos-cp.eu], nginx_conf_name: nexus }
        - { certbot_domains: [lists.icos-cp.eu], nginx_conf_name: phplist }
        - { certbot_domains: [restheart.icos-cp.eu], nginx_conf_name: restheart }
        - { certbot_domains: [sc.icos-ri.eu], nginx_conf_name: scicosri }
        - { certbot_domains: [static.icos-cp.eu], nginx_conf_name: static }
        - { certbot_domains: [thredds.icos-cp.eu], nginx_conf_name: thredds }




- hosts: icosprod2
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.geoip
      tags: geoip
