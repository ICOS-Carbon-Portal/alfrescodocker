# This ansible playbook will provision our production servers.

- import_playbook: setup.yml

- hosts: icosprod
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.restheart
      tags: restheart
    - role: icos.cpauth
      tags: cpauth
    - role: icos.cpdata
      tags: cpdata
    - role: icos.doi
      tags: doi
    - role: icos.filedrop
      tags: filedrop
    - { role: icos.ssh_incoming_tunnel,
        tags: ssh_incoming_tunnel,
        user: tunnel_icosprod2_meta,
        remote_host: "{{ meta_tunnel_from_ip }}",
        public_key: "{{ lookup('file', 'roles/icos.ssh_outgoing_tunnel/files/ssh_tunnel.pub') }}",
      }
    - { role: icos.pgrep,
        tags: pgrep,
        arg: "{{ pgrep_rdflog_instance }}"
      }


- hosts: icosprod2
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  tasks:
    - import_role:
        name: icos.cpmeta
        tasks_from: deploy
      tags: cpmeta_only

  roles:
    - role: icos.nexus
      tags: nexus
    - role: icos.rdflog
      tags: rdflog
    - role: icos.cpmeta
      tags: cpmeta
    - { role: icos.ssh_outgoing_tunnel,
        tags: ssh_outgoing_tunnel,
        remote_host: icosprod,
        remote_host_key: "{{ hostvars[meta_tunnel_to_host].ansible_ssh_host_key_ecdsa_public }}",
        remote_acct: tunnel_icosprod2_meta,
        remote_ip: "{{ meta_tunnel_to_ip }}",
        remote_name: meta,
        tunnel_args: "-R localhost:{{ meta_port }}:localhost:{{ meta_port }}"
      }
