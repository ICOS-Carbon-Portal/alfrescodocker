- hosts: postgis_host
  vars_files:
    - vault.yml
  pre_tasks:
    - name: Create postgis LXD profile
      tags: profile
      lxd_profile:
        name: postgis
        config:
          limits.cpu: "2"
          limits.memory: "4GB"
        devices:
          root:
            path: /
            type: disk
            pool: postgis
            size: "20GB"

  roles:
    - role: icos.lxd_host
      tags: lxd
      lxd_host_name: postgis
      lxd_host_port: "{{ hostvars['postgis'].ansible_port }}"
      lxd_host_profile: postgis

        
- hosts: postgis
  vars_files:
    - vault.yml
  roles:
    - role: icos.lxd_guest
      tags: guest
      lxd_guest_ssh_keys: "{{ vault_postgis_extra_keys }}"
        
    - role: icos.postgresql
      tags: postgresql
      postgresql_postgis_enable: true

    - role: icos.bbclient
      tags: bbclient
      bbclient_user: postgres
      bbclient_coldbackup_enable: no
      bbclient_remotes:
        - cdb.nateko.lu.se

  tasks:
    - name: Modify ~/.profile
      become: yes
      become_user: postgres
      lineinfile:
        create: yes
        path: /var/lib/postgresql/.profile
        regex: '^PATH='
        line: 'PATH=$HOME/bin:$PATH'
        state: present
