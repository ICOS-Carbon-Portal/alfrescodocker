- hosts: postgis_host
  become: true
  vars_files:
    - vault.yml
  pre_tasks:
    - name: Create postgis LXD profile
      tags: profile
      lxd_profile:
        name: postgis
        config:
          limits.cpu: "2"
          limits.memory: "4GB"
        devices:
          root:
            path: /
            type: disk
            pool: postgis
            size: "20GB"

  roles:
    - role: icos.lxd_host
      tags: lxd
      lxd_host_name: postgis
      lxd_host_port: "{{ hostvars['postgis'].ansible_port }}"
      lxd_host_profile: postgis

- hosts: postgis
  become: true
  roles:
    - role: icos.lxd_guest
      tags: guest

  tasks:
     - name: Adding the apt key for postgresql
       apt_key:
         id: ACCC4CF8
         url: https://www.postgresql.org/media/keys/ACCC4CF8.asc
         state: present
           
     - name: Adding the postgresql repo
       apt_repository:
         repo: >-
           deb http://apt.postgresql.org/pub/repos/apt/
           {{ansible_distribution_release}}-pgdg main
         filename: pgdg

     - name: Updating apt to fetch list of postgresql packages
       apt:
         update_cache: yes
         cache_valid_time: 3600
         force_apt_get: true

     - name: Installing Postgresql 12
       package:
         name: postgresql-12
         state: present

     - name: Installing PostGIS 3
       package:
         name: postgresql-12-postgis-3
         state: present
    
