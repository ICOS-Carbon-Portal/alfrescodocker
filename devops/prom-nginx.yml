# Metrics exporter for nextcloud.

- hosts:
    - icos1.gis.lu.se
    - fsicos2.lunarc.lu.se
    - fsicos3.lunarc.lu.se
  vars:
    # The prometheus exporters address.
    nginx_prom_addr: "127.0.0.1:9113"
    # The address to nginx's metrics page
    nginx_metrics_url: "http://127.0.0.1/metrics"
  tasks:
    - name: Enable stub_status for nginx
      copy:
        dest: /etc/nginx/conf.d/stub_status.conf
        content: |
          server {
            listen localhost:80;
            server_name localhost;

            location /metrics {
                stub_status on;
            }
          }

    - name: reload nginx
      shell: nginx -t && systemctl reload nginx
      changed_when: no

    - name: Check that nginx /metrics respond
      uri:
        url: "{{ nginx_metrics_url }}"
      retries: 10

    # Tried the nginx-prometheus-exporter as a docker container but ran into
    # problems.
    - name: Download nginx-prometheus-exporter
      include_role:
        name: icos.github_download_bin
      vars:
        dbin_user: nginxinc
        dbin_repo: nginx-prometheus-exporter
        # https://github.com/nginxinc/nginx-prometheus-exporter/releases/download/v0.11.0/nginx-prometheus-exporter_0.11.0_linux_amd64.tar.gz
        dbin_url: "{{ dbin__down }}/v{{ dbin__vers }}/nginx-prometheus-exporter_{{ dbin__vers.lstrip('v') }}_linux_amd64.tar.gz"
        dbin_src: "nginx-prometheus-exporter"

    - name: Create nginx-prometheus-exporter service
      copy:
        dest: /etc/systemd/system/nginx-prometheus-exporter.service
        content: |
          [Unit]
          Description=nginx-prometheus-exporter

          [Service]
          ExecStart={{ dbin_symlink.dest }} -nginx.scrape-uri={{ nginx_metrics_url }} -web.listen-address={{ nginx_prom_addr }}
          # unix:/var/run/nginx-prometheus-exporter.sock
          Restart=always

          [Install]
          WantedBy=multi-user.target

    - name: Start/restart nginx-prometheus-exporter
      systemd:
        daemon-reload: yes
        name: nginx-prometheus-exporter
        enabled: yes
        state: restarted
      changed_when: no

    - name: Check that nginx-prometheus-exporter respond
      uri:
        url: "http://{{ nginx_prom_addr }}/metrics"
      retries: 10

    - name: Add nginx-prometheus-exporter to vmagent's file discovery
      copy:
        dest: /opt/vmagent/file_sd_configs/nginx-exporter-host.yaml
        content: |
          # The node exporter on host.
          - targets:
              - {{ nginx_prom_addr }}
            labels:
              job: nginx
              instance: {{ inventory_hostname_short }}
