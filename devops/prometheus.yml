# Pull new docker versions
#   deploy prometheus prometheus_build -eprometheus_pull_latest=true
# Deploy new config files
#   deploy prometheus prometheus_config

- hosts: cdb.nateko.lu.se
  vars_files:
    - vault.yml
  vars:
    prometheus_admin_password: "{{ vault_prometheus_admin_password }}"
  roles:
    - role: icos.lxd_vm
      tags: vm
      lxd_vm_name: prometheus
      lxd_vm_docker: true
  tasks:
    - tags: cert
      import_role:
        name: icos.prometheus
        tasks_from: cert

    - name: Setup nginx for prometheus
      tags: nginx
      include_role:
        name: icos.prometheus
        tasks_from: nginx
        apply: {tags: ['nginx']}
      vars:
        prometheus_prom_host: prometheus.lxd
        prometheus_graf_host: prometheus.lxd
        prometheus_alrt_host: prometheus.lxd
        prometheus_bbox_host: prometheus.lxd


- hosts: prometheus
  vars_files:
    - vault.yml
  vars:
    prometheus_alrt_slack_url: "{{ vault_prometheus_alrt_slack_url }}"
    prometheus_graf_pass: "{{ vault_prometheus_graf_pass }}"
    prometheus_prom_dynamic: files/prometheus/dynamic
    prometheus_alrt_cf: files/prometheus/alertmanager-config.yml
    prometheus_bbox_cf: files/prometheus/blackbox-config.yml
    prometheus_prom_cf: files/prometheus/prometheus-config.yml

  roles:
    - role: icos.lxd_guest
      tags: guest

    - role: icos.docker
      tags: docker

  tasks:
    - name: Setup prometheus
      tags: setup
      import_role:
        name: icos.prometheus
        tasks_from: setup

    - name: Update prometheus dynamic configuration
      tags: config
      import_role:
        name: icos.prometheus
        tasks_from: config
