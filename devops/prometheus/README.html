<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<title>README.html</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>

</head>

<body>

<h1>Monitoring stack</h1>

<p>Provision our monitoring stack, which is a Prometheus stack consisting of:</p>

<ul>
<li>victoriametrics - drop-in replacement for Prometheus itself. Acts as database
and remote-write destination for vmagent</li>
<li>vmagent - one on each host. Scrapes the local targets for metrics and
remote-writes them to victoriametrics</li>
<li>grafana - frontend visualizer and alertmanager.</li>
</ul>

<h2>victoriametrics</h2>

<p>Victoriametrics is  started out as a replacement for Prometheus builtin database
(called tsdb). It then grew more features and can now be used as a faster,
leaner and more competent Prometheus replacement.</p>

<p>We have it configured to accept remote-writes from vmagent, acting as a "push"
destination.</p>

<p>It runs as a docker-compose project on cdb.</p>

<h2>vmagent</h2>

<p>Part of the Victoriametrics project. We have one running on each host. It's
responsible for scraping targets on the host and then forwarding the metrics to
victoriametrics.</p>

<h2>grafana</h2>

<p>Used for visualizations of the metrics. It also has alert capability by way of
a built in alertmanager (from the Prometheus project). It runs in the same
docker-compose stack as the victoriametrics database.</p>

<h1>Flowchart of monitoring stack</h1>

<p>```mermaid
flowchart LR</p>

<p>subgraph host1[fsicos3]
   vmagent1[vmagent]
   node_exporter
   textfiles{{textfiles directory}}
   lxdvm1{{lxdvm1}}
   lxdvm2{{lxdvm2}}
   lxdcron[cron job]
end</p>

<p>vmagent1 -- scrapes --> node<em>exporter
node</em>exporter -- reads --> textfiles
lxdcron -- scrapes --> lxdvm1 &amp; lxdvm2
lxdcron -- writes --> textfiles</p>

<p>subgraph host2[fsicos2]
  vmagent2[vmagent]
  fileshare[/fileshare container/]
  nextcloud[/metrics sidecar/]
end</p>

<p>vmagent2 -- scrapes --> nextcloud
vmagent2 -- writes --> victoriametrics
nextcloud &lt;--> fileshare</p>

<p>subgraph promhost[cdb]
  victoriametrics[/victoriametrics/]
  grafana[/grafana/]
end</p>

<p>grafana -- reads --> victoriametrics
vmagent1 -- writes --> victoriametrics
grafana -- alerts --> slack &amp; email</p>

<p>slack((slack))
email((email))
user((User))
user -- browses --> grafana
```</p>

</body>
</html>
