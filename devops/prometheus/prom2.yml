# VICTORIAMETRICS
- hosts: cdb.nateko.lu.se
  vars:
    # https://caddyserver.com/docs/caddyfile/directives/basicauth
    caddy_basic_auth: |
      basicauth bcrypt prometheus {
        user {{ "assenttalleycatchiest" |
                password_hash('bcrypt', vault_bcrypt_salt) }}
      }

    prom_graf_pass: "{{ vault_prom_graf_pass }}"

  roles:
    - role: icos.docker2
      tags: docker

    - role: icos.docker_utils
      tags: docker_utils

    - role: icos.caddy
      tags: caddy
      caddy_name: default
      caddy_conf: |
        cdb.nateko.lu.se {
          respond "Great success!"
        }

    - role: icos.prometheus2
      tags: prom
      prom_graf_domain: graf.icos-cp.eu

  tasks:
    - name: Install proxy configuration for prometheus
      tags: proxy
      import_role:
        name: icos.caddy
        tasks_from: site.yml
      vars:
        caddy_name: prometheus
        caddy_conf: |
          # SNIPPET
          (icosip) {
              remote_ip 130.235.74.215  # icos1
              remote_ip 194.47.223.139  # fsicos2
              remote_ip 194.47.223.137  # fsicos3
              remote_ip 130.235.99.237  # cdb
          }


          # GRAFANA
          graf.icos-cp.eu {
            # no basic auth for grafana, it has its own auth.
            reverse_proxy localhost:3000
          }


          # PROMETHEUS
          prom.icos-cp.eu {
            {{ caddy_basic_auth | indent(2) }}

            @api_not_icos {
              path /api/*
              not {
                import icosip
              }
            }

            respond @api_not_icos 401
            reverse_proxy localhost:8428
          }


# VMAGENT and CADDY
- hosts: fsicos2.lunarc.lu.se
  vars:

  roles:



# NODE EXPORTER
- hosts:
    - fsicos2.lunarc.lu.se
  vars:
    caddy_port: 60444
  roles:
    - role: icos.node_exporter
      tags: node_exporter

    # - role: icos.caddy
    #   tags: caddy
    #   caddy_name: default
    #   caddy_conf: |
    #     listen unix//run/caddy.sock

    #     fsicos2.lunarc.lu.se:{{ caddy_port }} {
    #       respond "Great success!"
    #     }

  tasks:
    - name: Add nextcloud to vmagent
      tags: nextcloud
      include_role:
        apply:
          tags: nextcloud
        name: icos.vmagent
        tasks_from: fsd
      vars:
        fsd_name: nextcloud
        fsd_target: "localhost:9205"
