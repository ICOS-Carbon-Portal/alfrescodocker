# FSICOS2 - RDFLOG
- hosts: fsicos2.lunarc.lu.se
  tags: rdflog
  roles:
    - role: icos.rdflog
  tasks:
    - name: Port forward for rdflog
      tags: forward
      iptables_raw:
        name: forward_rdflog
        table: nat
        rules: >-
          -A PREROUTING -p tcp --dport 60002
          -j DNAT --to-destination 172.20.0.2:5432


# CREATE VMS
- hosts: fsicos3.lunarc.lu.se cdb.nateko.lu.se
  tags: vm
  roles:
    - role: icos.lxd_vm
      lxd_vm_name: pgrep-rdflog
      lxd_vm_docker: true
      lxd_forward_port: "{{ hostvars[pgrep_vm_name].ansible_port }}"


# REPLICAS
- hosts: pgrep-rdflog@fsicos3 pgrep-rdflog@cdb
  tags: replica
  vars_files:
    - vault.yml
  roles:
    - role: icos.lxd_guest
      tags: guest

    - role: icos.docker
      tags: docker

    - role: icos.pgrep
      tags: pgrep
  tasks:
    - name: Add pgrep-rdflog to prometheus
      tags: prom
      include_role:
        name: icos.prometheus
        tasks_from: fsd
      vars:
        fsd_name: "postgres-exporter@{{ inventory_hostname }}"
        fsd_app: "rdflog"
        fsd_url: "/lxd/pgrep-rdflog/{{ pgrep_metric_port }}"
