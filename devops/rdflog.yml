# FSICOS2 - RDFLOG
- hosts: fsicos2.lunarc.lu.se
  roles:
    - role: icos.rdflog
      tags: rdflog

  tasks:
    - name: Port forward for rdflog
      tags: forward
      iptables_raw:
        name: forward_rdflog
        table: nat
        rules: >-
          -A PREROUTING -p tcp --dport 60002
          -j DNAT --to-destination 172.20.0.2:5432


# FSICOS3 - VM
- hosts: fsicos3.lunarc.lu.se
  tags: fsicos3
  roles:
    - role: icos.lxd_vm
      lxd_vm_name: pgrep-rdflog
      lxd_vm_docker: true
      lxd_forward_port: "{{ hostvars['pgrep-rdflog@fsicos3'].ansible_port }}"


# CDB - VM
- hosts: cdb.nateko.lu.se
  tags: cdb
  roles:
    - role: icos.lxd_vm
      lxd_vm_name: pgrep-rdflog
      lxd_vm_docker: true
      lxd_forward_port: "{{ hostvars['pgrep-rdflog@cdb'].ansible_port }}"


# REPLICAS
- hosts: pgrep-rdflog@fsicos3 pgrep-rdflog@cdb
  vars_files:
    - vault.yml
  roles:
    - role: icos.lxd_guest
    - role: icos.docker
    - role: icos.pgrep
  tasks:
    - name: Add pgrep-rdflog to prometheus
      tags: prom
      include_role:
        name: icos.prometheus
        tasks_from: fsd
      vars:
        fsd_name: "postgres-exporter@{{ inventory_hostname }}"
        fsd_app: "rdflog"
        fsd_url: "/lxd/pgrep-rdflog/{{ pgrep_metric_port }}"
