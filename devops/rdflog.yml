# Deploy the postgres replication containers
#   deploy rdflog pgrep

# RDFLOG
- hosts: rdflog_server
  tags: rdflog
  roles:
    - role: icos.rdflog


# CREATE VMS
- hosts: pgrep_rdflog_server
  tags: vm
  roles:
    - role: icos.lxd_vm
      lxd_vm_name: "{{ rdflog_vm_name }}"
      lxd_vm_docker: true


# REPLICAS
- hosts: pgrep_rdflog
  tags: replica
  roles:
    - role: icos.lxd_guest
      tags: guest

    - role: icos.docker
      tags: docker

    - role: icos.pgrep
      tags: pgrep

  tasks:
    - name: Add vms to prometheus
      tags: prom
      include_role:
        name: icos.prometheus
        tasks_from: fsd
        apply:
          tags: prom
      vars:
        fsd_name: "postgres-exporter@{{ inventory_hostname }}"
        fsd_app: "rdflog"
        fsd_url: "/lxd/{{ inventory_hostname }}/{{ pgrep_metric_port }}"
