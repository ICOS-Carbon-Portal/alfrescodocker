# Deploy the postgres replication containers
#   deploy rdflog pgrep

# RDFLOG
- hosts: rdflog_server
  tags: rdflog
  roles:
    - role: icos.rdflog
  tasks:
    - name: Port forward for rdflog
      tags: forward
      iptables_raw:
        name: forward_rdflog
        table: nat
        rules: >-
          -A PREROUTING -p tcp --dport {{ rdflog_ext_port }}
          -j DNAT --to-destination 127.0.0.1:{{ rdflog_db_port }}


# CREATE VMS
- hosts: pgrep_rdflog_server
  tags: vm
  roles:
    - role: icos.lxd_vm


# REPLICAS
- hosts: pgrep_rdflog
  tags: replica
  roles:
    - role: icos.lxd_guest
      tags: guest

    - role: icos.docker
      tags: docker

    - role: icos.pgrep
      tags: pgrep

  tasks:
    - name: Add pgrep-rdflog to prometheus
      tags: prom
      include_role:
        name: icos.prometheus
        tasks_from: fsd
        apply: {tags: ['prom']}
      vars:
        fsd_name: "postgres-exporter@{{ inventory_hostname }}"
        fsd_app: "rdflog"
        fsd_url: "/lxd/pgrep-rdflog/{{ pgrep_metric_port }}"
