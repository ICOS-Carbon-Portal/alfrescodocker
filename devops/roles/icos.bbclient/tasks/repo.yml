- name: Retrieve SSH IP data
  # This task relies on being run with 'become: no'. That way the
  # environment variable SSH_CONNECTION will be preserved.
  become: no
  shell: echo $SSH_CONNECTION | sed 's/ /\n/g'
  register: _ssh_client_connection
  changed_when: no

- delegate_to: "{{ bbclient_remote }}"
  become: no
  block:
    - name: Retrieve SSH IP data
      # This task relies on being run with 'become: no'. That way the
      # environment variable SSH_CONNECTION will be preserved.
      become: no
      shell: echo $SSH_CONNECTION | sed 's/ /\n/g'
      register: _ssh_server_connection
      changed_when: no

    - name: Retrieve remote host keys
      shell: |
        IP=$(echo $SSH_CONNECTION | cut -d ' ' -f 3);
        ssh-keyscan localhost | sed "s/^localhost/$IP/"
      register: _keys
      changed_when: no

    - name: Set facts about SSH connection
      set_fact:
        bbclient_ip: "{{ _ssh_client_connection.stdout_lines[2] }}"
        bbclient_remote_ip: "{{ _ssh_server_connection.stdout_lines[2] }}"
        bbclient_remote_keys: "{{ _keys.stdout }}"

    - name: Create repo directory for host
      become: yes
      file:
        path: "{{ bbclient_remote_repo }}"
        state: directory
        owner: "{{ bbclient_remote_user }}"
        group: "{{ bbclient_remote_user }}"

    - name: Install public key
      become: yes
      authorized_key:
        user: "{{ bbclient_remote_user }}"
        state: present
        key: "{{ bbclient_key_data }}"
        key_options: >-
          command="{{ bbclient_remote_bin }} serve --restrict-to-path {{ bbclient_remote_repo }}",from="{{ bbclient_ip }}",{% if bbclient_remote_has_restrict %}restrict{% else %}no-agent-forwarding,no-port-forwarding,no-user-rc,no-X11-forwarding{% endif %}

- name: Write SSH config
  blockinfile:
    owner: "{{ bbclient_user }}"
    group: "{{ bbclient_user }}"
    create: yes
    path: "{{ bbclient_ssh_config }}"
    mode: 0600
    marker: "# {mark} bbclient {{ bbclient_remote }}"
    block: |
      Host {{ bbclient_remote }}
        HostName {{ bbclient_remote_ip }}
        User {{ bbclient_remote_user }}
        Identityfile {{ bbclient_ssh_key }}

- name: Update known_hosts
  blockinfile:
    owner: "{{ bbclient_user }}"
    group: "{{ bbclient_user }}"
    create: yes
    path: "{{ bbclient_ssh_hosts }}"
    mode: 0600
    marker: "# {mark} {{ bbclient_remote }}"
    block: |
      {{ bbclient_remote_keys }}

- name: Initialize repo
  command: |
    {{ bbclient_bin }} init {{ bbclient_repo_url }} --encryption=none

- name: Remember repo url
  lineinfile:
    path: "{{ bbclient_repo_file}}"
    line: "{{ bbclient_repo_url }}"
    state: present
    create: yes

    
