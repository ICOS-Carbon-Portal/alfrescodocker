- name: Remove old Caddyfiles
  file:
    dest: "{{ item }}"
    state: absent
  loop:
    - "/etc/caddy/sites/Caddyfile.{{ caddy_name }}"
    - "/etc/caddy/{{ caddy_name }}.caddy"

- name: Add site config to Caddyfile
  blockinfile:
    marker: "# {mark} {{ caddy_name }}"
    state: "{{ caddy_site_state }}"
    create: yes
    insertafter: EOF
    path: /etc/caddy/Caddyfile
    block: "{{ caddy_conf }}"
    validate: caddy validate --config %s --adapter caddyfile
  register: r

- name: Reload caddy configuration
  command: caddy reload --config /etc/caddy/Caddyfile --adapter caddyfile
  changed_when: false
