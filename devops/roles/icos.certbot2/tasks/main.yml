- name: Check that all parameters are defined
  fail:
    msg: "{{ item }} needs to be defined"
  when: vars[item] is undefined
  loop:
    - certbot_name
    - certbot_domains

- name: Run certbot for {{ certbot_name }}
  command: |
    {{ certbot_bin }} certonly --nginx
    --cert-name {{ certbot_name }}
    --non-interactive --agree-tos --email {{ certbot_email }}
    {% for d in certbot_domains %} -d {{ d }} {% endfor %}
  register: _r
  changed_when: "'Certificate not yet due for renewal;' not in _r.stdout"
