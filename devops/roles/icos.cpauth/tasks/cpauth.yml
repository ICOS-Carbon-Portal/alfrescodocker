- name: Run the jarservice role
  include_role:
    name: icos.jarservice
  vars:
    username        : "{{ cpauth_username }}"
    jarfile         : "{{ cpauth_jar_file }}"
    # https://github.com/ansible/ansible/issues/20597
    apptemplate     : roles/icos.cpauth/templates/application.conf.j2
    nginxconfig     : "{{ cpauth_nginxconfig }}"
    servicename     : "{{ cpauth_servicename }}"
    servicetemplate : "{{ cpauth_template }}"

- name: Copy keys
  copy:
    src: privateKeys
    dest: /home/{{ cpauth_username }}/
    owner: "{{ cpauth_username }}"
    group: "{{ cpauth_username }}"

- meta: flush_handlers

- name: Install SSL certificate
  command: >
    certbot
    --authenticator webroot
    --installer nginx
    --non-interactive
    --webroot-path /usr/share/nginx/html/
    --domain cpauth.icos-cp.eu
    --domain auth.fieldsites.se
    --email carbon.admin@nateko.lu.se
    --agree-tos
  notify: reload nginx config

- meta: flush_handlers
