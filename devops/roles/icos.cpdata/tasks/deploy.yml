- name: Add systemd service
  template:
    src: cpdata.service
    dest: /etc/systemd/system/cpdata.service
  register: _service

- name: Copy jarfile
  copy:
    src: "{{ cpdata_jar_file }}"
    dest: "{{ cpdata_home }}/cpdata.jar"
    backup: true
  register: _jarfile

- name: Prune old jarfiles
  ansible.builtin.shell: |
    ls -1t *jar*~ | tail +6 | tee /dev/stderr | xargs rm -f
  args:
    executable: /bin/bash
    chdir: "{{ cpdata_home }}"
  register: _r
  changed_when:
    - _r.stderr

- import_tasks: config.yml
  tags: cpdata_config

- name: Check that the service responds
  uri:
    url: "https://{{ cpdata_domains | first }}/buildInfo"
    return_content: yes
  register: r
  failed_when: r.failed
  retries: 30
  delay: 10
  until: not r.failed
