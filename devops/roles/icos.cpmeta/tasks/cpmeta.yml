- import_role: name=icos.certbot

- name: Run the jarservice role
  import_role:
    name: icos.jarservice
  vars:
    username        : "{{ cpmeta_username }}"
    jarfile         : "{{ cpmeta_jar_file }}"
    apptemplate     : "{{ cpmeta_apptemplate }}"
    nginxconfig     : "{{ cpmeta_nginxconfig }}"
    servicename     : "{{ cpmeta_servicename }}"
    servicetemplate : "{{ cpmeta_template }}"

- block:
    - name: Create metaAppStorage
      file:
        path: "{{ cpmeta_filestorage_target }}"
        state: directory

    - name: Link link to file storage
      file:
        dest: "{{ cpmeta_filestorage_home }}"
        src: "{{ cpmeta_filestorage_target }}"
        state: link
  when: cpmeta_filestorage_target is defined

- block:
    - name: Ensure that the remotebackup script is present
      file:
        path: "{{ cpmeta_remotebackup_bin }}"
        mode: +x

    - name: Install cronjob to backup cpmetas fileStorage
      cron:
        name: Backup cpmeta fileStorage
        job: >-
          {{ cpmeta_remotebackup_bin }} -La {{ cpmeta_filestorage_home }} meta
        special_time: hourly
  when: cpmeta_enable_remotebackup
