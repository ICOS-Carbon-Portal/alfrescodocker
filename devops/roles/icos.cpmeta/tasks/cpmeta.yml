- include_role: name=icos.certbot

- name: Run the jarservice role
  include_role:
    name: icos.jarservice
  vars:
    servicename     : "{{ cpmeta_servicename }}"
    username        : "{{ cpmeta_username }}"
    jarfile         : "{{ cpmeta_jar_file }}"
    # Cannot use variables for paths to roles due to https://github.com/ansible/ansible/issues/10374
    configfile      : roles/icos.cpmeta/templates/application.conf
    nginxconfig     : roles/icos.cpmeta/files/meta.conf
    servicetemplate : roles/icos.cpmeta/templates/cpmeta.service

- name: Copy SSL certs and private key for Handle.net client
  copy:
    src: ssl
    dest: "{{ cpmeta_home }}/"
    owner: "{{ cpmeta_username }}"
    group: "{{ cpmeta_username }}"

- name: Create metaAppStorage directory (if not present), take ownership
  file:
    path: "{{ cpmeta_filestorage_target }}"
    state: directory
    owner: "{{ cpmeta_username }}"
    group: "{{ cpmeta_username }}"

- import_role: name=icos.bbclient
  vars:
    bbclient_name: "{{ cpmeta_username }}"
    bbclient_home: "{{ cpmeta_home }}"

- name: Copy backup.sh
  template:
    src: backup.sh
    dest: "{{ cpmeta_backup_script }}"
    mode: +x

- name: Add backup to crontab
  cron:
    job: "{{ cpmeta_backup_script }}"
    hour: "*"
    minute: "0"
    state: present
    name: "cpmeta_backup"
