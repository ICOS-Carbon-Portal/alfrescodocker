- name: Copy extra nginx config file
  copy:
    src: meta.conf.common
    dest: /etc/nginx/conf.d/

- name: Run the jarservice role
  import_role:
    name: icos.jarservice
  vars:
    username        : "{{ cpmeta_username }}"
    jarfile         : "{{ cpmeta_jar_file }}"
    appconfig       : "{{ cpmeta_appconfig }}"
    nginxconfig     : "{{ cpmeta_nginxconfig }}"
    servicename     : "{{ cpmeta_servicename }}"
    servicetemplate : "{{ cpmeta_template }}"

# https://github.com/ansible/ansible/issues/15901
- name: Get home directory of {{ cpmeta_username }}
  become_user: "{{ cpmeta_username }}"
  shell: "getent passwd {{ cpmeta_username }} | cut -d: -f6"
  register: cpmeta_home
  changed_when: false

- name: Create link to file storage
  become: yes
  become_user: "{{ cpmeta_username }}"
  file:
    dest: "{{ cpmeta_home.stdout }}/fileStorage"
    src: "{{ cpmeta_filestorage_target }}"
    state: link
  when: cpmeta_filestorage_target is defined

- import_role:
    name: icos.certbot
  vars:
    - certbot_domains: meta.fieldsites.se
