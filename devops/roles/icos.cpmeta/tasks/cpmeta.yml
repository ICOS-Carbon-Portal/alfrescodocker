- name: Copy extra nginx config file
  copy:
    src: meta.conf.common
    dest: /etc/nginx/conf.d/

- name: Run the jarservice role
  include_role:
    name: icos.jarservice
  vars:
    username        : "{{ cpmeta_username }}"
    jarfile         : "{{ cpmeta_jar_file }}"
    appconfig       : "{{ cpmeta_appconfig }}"
    nginxconfig     : "{{ cpmeta_nginxconfig }}"
    servicename     : "{{ cpmeta_servicename }}"
    servicetemplate : "{{ cpmeta_template }}"

# https://github.com/ansible/ansible/issues/15901
- name: Get home directory of {{ cpmeta_username }}
  become_user: "{{ cpmeta_username }}"
  shell: "getent passwd {{ cpmeta_username }} | cut -d: -f6"
  register: cpmeta_home

- name: Create link to file storage
  become: yes
  become_user: "{{ cpmeta_username }}"
  file:
    dest: "{{ cpmeta_home.stdout }}/fileStorage"
    src: "{{ cpmeta_filestorage_target }}"
    state: link

- meta: flush_handlers

- name: Install SSL certificate
  command: >
    certbot
    --authenticator webroot
    --installer nginx
    --non-interactive
    --webroot-path /usr/share/nginx/html/
    --domain meta.fieldsites.se
    --email carbon.admin@nateko.lu.se
    --agree-tos
  notify: reload nginx config

- meta: flush_handlers
