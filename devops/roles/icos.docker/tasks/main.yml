- name: Install docker and pip3
  apt:
    name:
      - docker.io
      - python3-pip

- name: Install docker-compose
  pip:
    name: docker-compose

- name: Install docker configuration
  copy:
    src: daemon.json
    dest: /etc/docker/
  notify: reload docker

- name: Start docker
  systemd:
    name: docker
    state: started
    enabled: yes

- name: Copy docker helper scripts
  copy:
    src: "{{ item }}"
    dest: "/usr/local/sbin/{{ item }}"
    mode: +x
  loop:
    - docker-unpack-image
    - docker-lineage
    - docker-list-ips
    - docker-entrypoint
    - docker-extract
    - docker-builds
    - docker-enter

- name: Create /docker directory
  file:
    path: /docker
    state: directory

- name: Copy Makefile for docker-compose projects
  copy:
    src: Makefile
    dest: /docker/Makefile

# Upgrading docker will restart containerd. Restarting containerd, even with
# live-restore enabled, will mess up networking for some applications - notably
# jupyterhub.
- name: Make sure docker isn't upgraded
  dpkg_selections:
    name: "{{ item }}"
    selection: "{{ 'hold' if docker_prevent_upgrade else 'install' }}"
  loop:
    - docker.io
    - containerd


- import_tasks: cleanup.yml
  tags: docker_cleanup
  when: docker_periodic_cleanup

- import_tasks: utils.yml
  tags: docker_utils
