---
- name: Create project directory
  file:
    path: "{{ project_dir }}"
    state: directory

- name: Pull source code from git
  git:
    repo: https://github.com/ICOS-Carbon-Portal/drupal
    version: "{{ git_version | default('master') }}"
    dest: "{{ project_dir }}"
    force: yes

- name: Create {{ project_dir }}/config/ directory
  file: path={{ project_dir }}/config/ state=directory recurse=yes

- name: Copy uploads config
  copy:
    src: uploads.ini
    dest: "{{ project_dir }}/config/uploads.ini"

- name: Create {{ project_dir }}/files/private/ directory
  file: path={{ project_dir }}/files/private/ state=directory recurse=yes

- name: Create {{ project_dir }}/files/default/files/ directory
  file: path={{ project_dir }}/files/default/files/ state=directory recurse=yes

- name: Copy settings.php
  template:
    src: settings.php.j2
    dest: "{{ project_dir }}/files/default/settings.php"

- name: Copy services.yml
  copy:
    src: services.yml
    dest: "{{ project_dir }}/files/default/"

- name: Copy theme library
  template:
    src: cp_theme_d8.libraries.yml.j2
    dest: "{{ project_dir }}/themes/cp_theme_d8/cp_theme_d8.libraries.yml"

- name: Ensure {{ project_dir }}/docker/ directory exists
  file: path={{ project_dir }}/docker/ state=directory recurse=yes

- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: "{{ project_dir }}/docker/docker-compose.yml"

- name: Copy environment file
  template:
    src: env.j2
    dest: "{{ project_dir }}/docker/.env"

- name: Run docker-compose
  docker_compose:
    project_src: "{{ project_dir }}/docker"
    state: present
    pull: yes

- name: Change private directory owner
  command: docker exec {{website}}_drupal_1 chown -R www-data:www-data /var/www/private/

- name: Change files directory owner
  command: docker exec {{website}}_drupal_1 chown -R www-data:www-data /var/www/html/sites/default/files
