server {
  listen       443 ssl;
  server_name  {{ domain }};

{% if project_name == "ri" %}
  ssl_certificate_key /etc/nginx/ssl/ri/icos-ri.eu.key;
  ssl_certificate /etc/nginx/ssl/ri/icos-ri.eu.bundle.crt;

  location =/science-conference {
    return 301 https://conference.icos-ri.eu/;
  }
{% endif %}

  client_max_body_size 100M;

  location ~ /.well-known {
    root /usr/share/nginx/html;
  }

  location / {
    if ($arg_q ~* "^user"){
      return 403;
    }
    if ($arg_login) {
      proxy_pass http://127.0.0.1:8080;
    }

    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $remote_addr;

    proxy_pass http://127.0.0.1:{{ drupal_docker_port }};
  }
}

server {
  listen       80;
  server_name  {{ domain }};
  return 301   https://{{ domain }}$request_uri;
}

{% if project_name == "ac" %}
server {
  listen       80;
  server_name  www.actris.se;
  return 301   https://{{ domain }}$request_uri;
}
{% elif project_name == "ri" %}
server {
  listen       80;
  server_name  icos-ri.eu icos-infrastructure.eu www.icos-infrastructure.eu;
  return 301   https://www.icos-ri.eu$request_uri;
}

server {
  listen       443 ssl;
  server_name  icos-ri.eu;
  ssl_certificate_key /etc/nginx/ssl/ri/icos-ri.eu.key;
  ssl_certificate /etc/nginx/ssl/ri/icos-ri.eu.bundle.crt;
  return 301   https://www.icos-ri.eu$request_uri;
}
{% elif project_name == "fi" %}
server {
  listen       80;
  server_name  icos-finland.fi;
  return 301   https://www.icos-finland.fi$request_uri;
}
server {
  listen       443 ssl;
  server_name  icos-finland.fi;
  return 301   https://www.icos-finland.fi$request_uri;
}
{% endif %}
