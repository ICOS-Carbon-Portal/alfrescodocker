server {
    listen       443 ssl;
    server_name  geoip.icos-cp.eu;

  {% if certbot_delegate is undefined and certbot_install_certificate | default(true) %}
    ssl_certificate /etc/letsencrypt/live/geoip.icos-cp.eu/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/geoip.icos-cp.eu/privkey.pem;
  {% endif %}

    location ~ /.well-known {
      root /usr/share/nginx/html;
    }

    # Keep the geoip logs separate to better get an idea of its usage.
    access_log   /var/log/nginx/geoip.log;

    location / {
        # Our wildcard DNS points to fsicos but we want to deploy to fsicos2. A
        # reverse-proxy is set up on fsicos, but we still want the access
        # restrictions to work.
        set_real_ip_from 194.47.223.133; # fsicos

        {{ geoip_nginx_allow_deny | indent(8) }}
        proxy_pass http://127.0.0.1:{{ geoip_host_port }};
        proxy_set_header Host $host;
    }
}
