- include_vars: "{{ ansible_machine }}.yml"

- block:
    - name: Create download directory
      file:
        path: "{{ dbin_download_dir }}"
        state: directory
      register: _create

  # FIXME: Remove in 2024
  rescue:
    - name: Remove file that blocks download dir
      when: _create.msg.endswith('already exists as a file')
      file:
        path: "{{ dbin_download_dir }}"
        state: absent

    - name: Create download directory
      file:
        path: "{{ dbin_download_dir }}"
        state: directory

- name: Retrieving latest tag for {{ dbin_repo }}
  run_once: true
  delegate_to: localhost
  github_release:
    user: "{{ dbin_user }}"
    repo: "{{ dbin_repo }}"
    action: latest_release
  register: _release

- name: Download {{ dbin_repo }}
  get_url:
    url: "{{ _dbin_url }}"
    dest: "{{ dbin_download_dir }}"
  # This variable can be checked by our users to determine whether anything has
  # changed.
  register: dbin_download

- name: Unarchive {{ _dbin_name }} tarball
  when: _dbin_unar
  unarchive:
    src: "{{ dbin_download.dest }}"
    dest: "{{ dbin_download_dir }}"
    remote_src: true
    list_files: true
  register: _unar

- name: Create symlink for {{ _dbin_name }}
  file:
    dest: "{{ dbin_bin_dir }}/{{ _dbin_name }}"
    src: "{{ _dbin_src }}"
    state: link
  register: dbin_symlink

- name: Make sure {{ _dbin_name }} is executable
  file:
    path: "{{ _dbin_src }}"
    mode: +x
