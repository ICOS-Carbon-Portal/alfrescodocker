- name: Create limesurvey user
  user:
    name: "{{ limesurvey_user }}"
    group: "{{ limesurvey_group }}"
    state: present
    create_home: yes
    home: "{{ limesurvey_home }}"

- include_role: name=icos.certbot

- name: Create limesurvey volumes
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ limesurvey_user }}"
    group: "{{ limesurvey_group }}"
  loop:
    - "{{ limesurvey_volume_upload }}"
    - "{{ limesurvey_volume_mysql }}"

- name: Copy limesurvey nginx conf to nginx/conf.d
  template:
    src: limesurvey.conf
    dest: /etc/nginx/conf.d/limesurvey.conf
    owner: root
    group: root
    mode: 0700
  notify: reload nginx config

- name: Copy docker-compose.yml
  copy:
    src: docker-compose.yml
    dest: "{{ limesurvey_home }}/docker-compose.yml"
    owner: limesurvey
    mode: g=rw

- name: Run limesurvey docker compose
  docker_service:
    project_src: "{{ limesurvey_home }}"
    state: present