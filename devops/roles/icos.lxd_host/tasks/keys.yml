# To be able to access the container via ssh, ssh keys have to be added.
# The choices as to which keys to add are:
#   1. generate keys - either locally, on the remote machine or in the conatiner
#   2. pre-generate keys and keep as part of this role
#   3. add some other, pre-existing keys
#
# This tasks uses choice 3 and takes the authorized_keys file from a user on
# the remote machine and merges into the container. The user is typically the
# same used by ansible to deploy the container.
- name: Merge {{ lxd_host_key_file }} into the container
  shell: >-
    lxc exec {{ lxd_host_name }} -- bash -c '
    while read line; do
    grep -qFx "$line" .ssh/authorized_keys || {
    echo "$line"; echo "$line" >> .ssh/authorized_keys;
    }; done
    ' < {{ lxd_host_key_file }}
  register: r
  # Each merged key is echoed, thus we know if any were added.
  changed_when: r.stdout != ""
  when: lxd_host_key_file is defined

- name: Add extra ssh-key to container
  shell: >-
    lxc exec {{ lxd_host_name }} -- bash -c '
    while read line; do
    grep -qFx "$line" .ssh/authorized_keys || {
    echo "$line"; echo "$line" >> .ssh/authorized_keys;
    }; done'
  args:
    stdin: "{{ item }}"
    stdin_add_newline: true
  register: r
  # Each merged key is echoed, thus we know if any were added.
  changed_when: r.stdout != ""
  loop: "{{ lxd_host_extra_keys }}"
