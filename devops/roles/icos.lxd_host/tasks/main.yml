- name: Check that all parameters are defined
  fail:
    msg: "{{ item }} needs to be defined"
  when: vars[item] is undefined
  loop:
    - lxd_host_name
    - lxd_host_port

- name: Create the {{ lxd_host_name }} container
  lxd_container:
    name: "{{ lxd_host_name }}"
    source:
      type: image
      mode: pull
      server: https://cloud-images.ubuntu.com/releases
      protocol: simplestreams
      alias: "18.04"
    config: "{{ lxd_host_config | default(omit) }}"
    profiles: "{{ lxd_host_profiles | default(omit) }}"
    wait_for_ipv4_addresses: true
    wait_for_ipv4_interfaces: eth0
    timeout: 30
  register: _lxd

- set_fact:
    lxd_host_ip: "{{ _lxd.addresses.eth0 | first }}"

- name: Add port forward for {{ lxd_host_name }} ssh
  blockinfile:
    marker: "# {mark} ansible / ssh to lxd {{ lxd_host_name }}"
    backup: yes
    create: no
    insertafter: EOF
    path: /etc/ufw/before.rules
    block: |
      *nat
      :PREROUTING ACCEPT [0:0]
      -A PREROUTING -p tcp --dport {{ lxd_host_port }} -j DNAT --to-destination {{ lxd_host_ip }}:22
      COMMIT
  notify: Reload UFW

- name: Allow traffic on containers external ssh port
  ufw:
    route: true
    rule: allow
    port: "'{{ lxd_host_port }}'"
    comment: "ssh to lxd {{ lxd_host_name }}"
  notify: Reload UFW

- import_tasks: keys.yml
  tags: lxd_host_keys
