- name: Create storage for docker
  when: lxd_vm_docker
  include_role:
    name: icos.zfsdocker
    public: yes
  vars:
    zfsdocker_name: "{{ lxd_vm_name }}"
    zfsdocker_size: "50G"

- name: Create profile for {{ lxd_vm_name }}
  when: lxd_vm_docker
  lxd_profile:
    name: "{{ lxd_vm_name }}_docker"
    config:
      security.nesting: "true"
    devices:
      docker:
        path: /var/lib/docker
        source: "{{ zfsdocker_zvol }}"
        type: disk
        raw.mount.options: user_subvol_rm_allowed

- name: Create container
  lxd_container:
    name: "{{ lxd_vm_name }}"
    state: started
    profiles:
      - default
      - ssh_root
      - "{{ '%s_docker' % lxd_vm_name if lxd_vm_docker else omit }}"
    source:
      type: image
      mode: pull
      server: https://cloud-images.ubuntu.com/releases
      protocol: simplestreams
      alias: "20.04"
    devices:
      root:
        path: "/"
        pool: "default"
        type: "disk"
        size: "50GB"
    wait_for_ipv4_addresses: true
    wait_for_ipv4_interfaces: eth0
    timeout: 60
  register: _lxd

- set_fact: |
    {{ lxd_vm_name | replace('-', '_') }}_ip={{ _lxd.addresses.eth0 | first }}

- include_role:
    name: icos.lxd_forward
  vars:
    lxd_forward_name: "{{ lxd_vm_name }}"
    lxd_forward_ip: "{{ _lxd.addresses.eth0 | first }}"

- name: Extract key
  command: >-
    lxc exec {{ lxd_vm_name }}
    awk '{print $1, $2}' /etc/ssh/ssh_host_ecdsa_key.pub
  register: key
  changed_when: no

- name: Add key to known_hosts
  local_action:
    module: known_hosts
    name: "[{{ inventory_hostname }}]:{{ lxd_forward_port }}"
    key: "[{{ inventory_hostname }}]:{{ lxd_forward_port }} {{ key.stdout}}"
