- name: Include tasks for cdb
  include_tasks: cdb.yml
  when: ansible_host == 'cdb.nateko.lu.se'

- name: Include tasks for fsicos2
  include_tasks: fsicos2.yml
  when: ansible_host == 'fsicos2.lunarc.lu.se'

- name: Include tasks for fsicos3
  include_tasks: fsicos3.yml
  when: ansible_host == 'fsicos3.lunarc.lu.se'

- name: One of the host-specific task files must have run.
  assert:
    that: _lxd is defined
  changed_when: no

- name: Set fact {{ lxd_vm_name }}_ip = {{ lxd_vm_ip }}
  set_fact: |
    {{ lxd_vm_name | replace('-', '_') }}_ip={{ lxd_vm_ip }}

- name: Extract host_ecdsa_key from the {{ lxd_vm_name }} VM
  command: >-
    lxc exec {{ lxd_vm_name }}
    awk '{print $1, $2}' /etc/ssh/ssh_host_ecdsa_key.pub
  register: _key
  changed_when: no

- name: Forward ssh port and create /etc/hosts entry
  include_role:
    name: icos.lxd_forward
  vars:
    lxd_forward_name: "{{ lxd_vm_name }}"
    lxd_forward_ip: "{{ lxd_vm_ip }}"
    lxd_forward_port: "{{ lxd_vm_port }}"

- name: Add local known_host {{ inventory_hostname }}:{{ lxd_vm_port }}
  local_action:
    module: known_hosts
    name: "[{{ inventory_hostname }}]:{{ lxd_vm_port }}"
    key: "[{{ inventory_hostname }}]:{{ lxd_vm_port }} {{ _key.stdout}}"
