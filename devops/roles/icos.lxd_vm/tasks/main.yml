- name: Include tasks for ext4 variant
  include_tasks: ext4.yml
  when: lxd_vm_variant == 'ext4'

- name: Include tasks for zfs variant
  include_tasks: zfs.yml
  when: lxd_vm_variant == 'zfs'

- name: Create container
  lxd_container:
    name: "{{ lxd_vm_name }}"
    state: started
    profiles: "{{ __lxd_vm_profiles }}"
    source: "{{ lxd_source }}"
    config: "{{ __lxd_vm_config }}"
    devices: "{{ __lxd_vm_devices }}"
    wait_for_ipv4_addresses: true
    wait_for_ipv4_interfaces: eth0
    timeout: 600
  register: _lxd

- name: Set fact ip fact for lxd_vm
  set_fact: |
    {{ lxd_vm_name | replace('-', '_') }}_ip={{ lxd_vm_ip }}

- name: Extract host_ecdsa_key from the VM
  command: >-
    lxc exec {{ lxd_vm_name }}
    awk '{print $1, $2}' /etc/ssh/ssh_host_ecdsa_key.pub
  register: _key
  changed_when: no
  retries: 10
  delay: 5
  until: _key.rc == 0

- name: Inject ssh root key into the VM
  command: >-
    lxc exec {{ lxd_vm_name }} --
    bash -c "grep -q '{{ lxd_vm_root_key }}' /root/.ssh/authorized_keys ||
            { echo '{{ lxd_vm_root_key }}' >> /root/.ssh/authorized_keys;
              echo added; }"
  register: _r
  changed_when: '"added" in _r.stdout'

- import_tasks: forward.yml
  tags: lxd_vm_forward
  when: lxd_vm_forward
