- name: Include tasks for ext4 variant
  include_tasks: ext4.yml
  when: lxd_vm_variant == 'ext4'

- name: Include tasks for zfs variant
  include_tasks: zfs.yml
  when: lxd_vm_variant == 'zfs'

- name: Create container
  lxd_container:
    name: "{{ lxd_vm_name }}"
    state: started
    profiles: "{{ __lxd_vm_profiles }}"
    source: "{{ lxd_source }}"
    config: "{{ __lxd_vm_config }}"
    devices: "{{ __lxd_vm_devices }}"
    wait_for_ipv4_addresses: true
    wait_for_ipv4_interfaces: eth0
    timeout: 600
  register: _lxd

- name: Set fact ip fact for lxd_vm
  set_fact: |
    {{ lxd_vm_name | replace('-', '_') }}_ip={{ lxd_vm_ip }}

- name: Extract host_ecdsa_key from the VM
  command: >-
    lxc exec {{ lxd_vm_name }}
    awk '{print $1, $2}' /etc/ssh/ssh_host_ecdsa_key.pub
  register: _key
  changed_when: no
  retries: 10
  delay: 5
  until: _key.rc == 0

- name: Forward ssh port and create /etc/hosts entry
  include_role:
    name: icos.lxd_forward
  vars:
    lxd_forward_name: "{{ lxd_vm_name }}"
    lxd_forward_ip: "{{ lxd_vm_ip }}"
    lxd_forward_port: "{{ lxd_vm_port }}"

- name: Add local known_host
  local_action:
    module: known_hosts
    name: "[{{ inventory_hostname }}]:{{ lxd_vm_port }}"
    key: "[{{ inventory_hostname }}]:{{ lxd_vm_port }} {{ _key.stdout}}"

- name: Add vm to local ssh config
  local_action:
    module: community.general.ssh_config
    ssh_config_file: "~{{ lookup('env', 'USER') }}/.ssh/config.icos"
    hostname: "{{ inventory_hostname }}"
    remote_user: root
    host: "{{ lxd_vm_inventory_hostname }}"
    port: "{{ lxd_vm_port }}"
    state: present
