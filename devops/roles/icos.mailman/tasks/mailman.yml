- name: Include mailman-vault
  include_vars: "mailman-vault.yml"

- name: Create user for mailman
  user:
    name: "{{ mailman_user }}"
    state: present
    home: "{{ mailman_home }}"
  register: _user

- name: Create docker build dirs
  file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ mailman_build_core }}"
    - "{{ mailman_build_web }}"
    - "{{ mailman_build_database }}"

- name: Install Dockerfiles
  template:
    dest: "{{ item.dest }}/Dockerfile"
    src: "{{ item.src }}"
  loop:
    - { src: Dockerfile.core, dest: "{{ mailman_build_core }}" }
    - { src: Dockerfile.web, dest: "{{ mailman_build_web }}" }
    - { src: Dockerfile.database, dest: "{{ mailman_build_database }}" }

- name: Create mailman volumes
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ _user.uid }}"
    group: "{{ _user.group }}"
  loop:
    - "{{ mailman_volume_core }}"
    - "{{ mailman_volume_web }}"
    - "{{ mailman_volume_database }}"

- name: Install mailman docker-compose.yml
  template:
    dest: "{{ mailman_home }}/"
    src: docker-compose.yml
    mode: 0600

- include_role: name=icos.certbot

- name: Install the mailman nginx conf to nginx/conf.d
  template:
    dest: /etc/nginx/conf.d/
    src: mailman.conf
  notify: reload nginx config

- name: Install mailman extra-conf file
  template:
    dest: "{{ mailman_volume_core }}/mailman-extra.cfg"
    src: mailman-extra.cfg

- name: Install django settings file for mailman-web
  template:
    dest: "{{ mailman_volume_web }}/settings_local.py"
    src: settings_local.py

- name: Build image using docker-compose
  shell: |
    ( echo -n '=== starting build '; date; docker-compose build ) \
    | tee -a build.log
  args:
    chdir: "{{ mailman_home }}"
  register: _build
  changed_when: '" ---> Running in " in _build.stdout'

- name: Start containers
  docker_service:
    project_src: "{{ mailman_home }}"

- name: Set configuration parameters
  postconf:
    param: "{{ item.param }}"
    value: "{{ item.value }}"
    append: "{{ item.append | default(omit) }}"
  loop: "{{ mailman_postfix_config }}"
