- name: Include mailman-vault
  include_vars: "mailman-vault.yml"

- name: Create user for mailman
  user:
    name: "{{ mailman_user }}"
    state: present
    home: "{{ mailman_home }}"
  register: _user

- name: Install mailman docker-compose.yml
  template:
    dest: "{{ mailman_home }}/"
    src: docker-compose.yml
    mode: 0600

- include_tasks: mailman_build.yml
- include_tasks: mailman_run.yml

- include_role: name=icos.certbot
  when: not certbot_disabled

- name: Install the mailman nginx conf to nginx/conf.d
  template:
    dest: /etc/nginx/conf.d/
    src: mailman.conf
  notify: reload nginx config
  when: not certbot_disabled

- name: Set postfix parameters
  postconf:
    param: "{{ item.param }}"
    value: "{{ item.value }}"
    append: "{{ item.append | default(omit) }}"
  loop: "{{ mailman_postfix_config }}"

- import_role: name=icos.bbclient
  vars:
    bbclient_name: mailman
    bbclient_home: "{{ mailman_home }}"
    bbclient_coldbackup_crontab: { hour: 02, minute: 40 }
