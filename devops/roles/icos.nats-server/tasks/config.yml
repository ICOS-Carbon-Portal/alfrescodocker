- name: Copy natsd.conf
  copy:
    content: "{{ nats_config }}"
    dest: "{{ nats_config_file }}"
    mode: 0640
    owner: root
    # nats is running as its own user which must be able to read the file.
    group: "{{ nats_user }}"
  register: _conf


- name: Test NATS configuration
  command: "{{ nats_server }} -t -c {{ nats_config_file }}"
  changed_when: false


# A nats context is simply a saved configuration. We save a configuration
# called "sys" which contains the username/password that allows us to connect
# to our local nats server with system privileges. We also make this context
# the default (by using --select). This way we can simply run "nats server ..."
# as root and have full access.
- name: Create nats sys context
  command: >-
    {{ nats_cli }} context save sys --select
    --user sys --password "{{ nats_sys_password }}"
  changed_when: false
  when: nats_sys_password is defined


# https://github.com/nats-io/nats-server/blob/master/util/nats-server.service
- name: Install NATS systemd unit
  copy:
    dest: "/etc/systemd/system/nats.service"
    content: |
      [Unit]
      Description=NATS Server
      After=network-online.target ntp.service

      [Service]
      PrivateTmp=true
      Type=simple
      ExecStart={{ nats_server }} -c {{ nats_config_file }}
      ExecReload=/bin/kill -s HUP $MAINPID
      ExecStop=/bin/kill -s SIGINT $MAINPID
      User={{ nats_user }}
      Group={{ nats_user }}
      # Used to trigger using Lame Duck Mode (LDM) shutdown
      KillSignal=SIGUSR2
      Restart=on-failure

      [Install]
      WantedBy=multi-user.target

- name: Start NATS service
  systemd:
    name: nats
    enabled: yes
    state: started
    daemon-reload: yes

- name: Make sure NATS is up and running correct version
  shell: nats server info
