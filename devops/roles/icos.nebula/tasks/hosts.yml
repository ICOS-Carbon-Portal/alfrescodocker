- name: Generate list of nebula hosts
  when: nebula_hosts_enable
  command: >-
    ab-nebula-util list {{ item | dirname }} --domain {{ nebula_interface }}
  register: r
  run_once: true
  delegate_to: localhost
  changed_when: false
  # Using fileglob is a hack to make ansible find nebula_ca_path using its
  # normal search_path lookup. "{{ item }}" will be the resolved path.
  with_fileglob:
    - "{{ nebula_ca_path }}"

- name: Add nebula hosts to hosts
  blockinfile:
    marker: "# {mark} ansible / nebula"
    create: no
    insertafter: EOF
    path: /etc/hosts
    block: "{{ r.results[0].stdout if nebula_hosts_enable else '' }}"
    state: "{{ 'present' if nebula_hosts_enable else 'absent' }}"
