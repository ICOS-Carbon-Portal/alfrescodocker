- name: Create nextcloud docker directory
  file:
    path: "{{ nextcloud_home }}"
    state: directory
    mode: og-rw

- include_role:
    name: icos.password_env_file
  vars:
      file: "{{ item.file }}"
      set_fact: "{{ item.set_fact }}"
      file_var: "{{ item.file_var }}"
  loop:
    - file: "{{ nextcloud_home }}/.pg-root-pass"
      set_fact: nextcloud_db_root_pass
      file_var: POSTGRES_PASSWORD
    - file: "{{ nextcloud_home }}/.pg-nextcloud-pass"
      set_fact: nextcloud_db_pass
      file_var: NEXTCLOUD_PASSWORD

- name: Copy {{ item.name }}
  template:
    src: "{{ item.name }}"
    dest: "{{ nextcloud_home }}"
    mode: "{{ item.mode | default(omit) }}"
  loop:
    - name: occ
      mode: +x
    - name: nextcloud.env
      mode: o-r
    - name: postgres.env
      mode: o-r
    - name: tweak.conf
    - name: init.sql
    - name: docker-compose.yml

- name: Create /usr/local/sbin/occ symlink
  file:
    dest: "/usr/local/sbin/occ"
    src: "{{ nextcloud_home }}/occ"
    state: link

- name: Check docker-compose config
  command: docker-compose config
  args:
    chdir: "{{ nextcloud_home }}"
  changed_when: no
