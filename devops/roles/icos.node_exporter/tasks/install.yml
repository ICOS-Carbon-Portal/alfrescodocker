- name: Create node_exporter user
  user:
    name: "{{ node_exporter_user }}"
    home: "{{ node_exporter_home }}"
    shell: /usr/sbin/nologin

- name: Clone textfile-collector-scripts
  git:
    repo: https://github.com/prometheus-community/node-exporter-textfile-collector-scripts
    version: master
    dest: "{{ node_exporter_scripts }}"

- name: Install utils needed for the collector-scripts
  apt:
    name: moreutils  # sponge(1)

- name: Download node_exporter
  include_role:
    name: icos.github_download_bin
  vars:
    dbin_download_dir: "{{ node_exporter_download }}"
    dbin_user: prometheus
    dbin_repo: node_exporter
    dbin_path: node_exporter
    dbin_arch: "{{ node_exporter_arch }}"

- name: Create the textfile collector directory
  file:
    path: "{{ node_exporter_textfiles }}"
    # Setup this directory in the same way as /tmp, i.e anyone can write to it
    # but not remove other user's files.
    mode: '1777'
    state: directory

- import_tasks: systemd.yml
  tags: node_exporter_systemd

- name: Allow node_exporter through firewall
  when: node_exporter_allow
  iptables_raw:
    name: allow_node_exporter
    rules: >-
      -A INPUT -p tcp --dport {{ node_exporter_listen }} -j ACCEPT
