- name: Copy node-exporter systemd files
  template:
    dest: /etc/systemd/system/
    src: "{{ item }}"
  loop:
    - node-exporter.service
    - node-exporter.socket
  register: _sysd

- name: Create the EnvironmentFile used by the systemd service
  copy:
    dest: "{{ node_exporter_environ }}"
    content: |
      OPTIONS=--collector.textfile.directory={{ node_exporter_textfiles }}
  register: _env

# FIXME: Remove in 2024.
# Not needed since it became socket activated.
- name: Stop node-exporter service
  systemd:
    name: node-exporter.service
    state: stopped
  changed_when: no

- name: Start/restart node-exporter.socket
  systemd:
    daemon-reload: "{{ 'yes' if _sysd.changed else 'no' }}"
    name: node-exporter.socket
    enabled: yes
    state: "{{ 'restarted' if _sysd.changed else 'started' }}"
