- name: Create build directory
  file:
    path: "{{ onlyoffice_build_dir }}"
    state: directory
    mode: o-r

- name: Copy build files
  copy:
    dest: "{{ onlyoffice_build_dir }}"
    src: "{{ item }}"
  loop:
    - Dockerfile
    - droidserif.tgz

- name: Copy runtime environment file
  template:
    src: onlyoffice.env
    dest: "{{ onlyoffice_home }}"
    mode: "o-r"

- name: Copy docker-compose.yml
  copy:
    src: docker-compose.yml
    dest: "{{ onlyoffice_home }}"

- name: Copy parsetime environment file
  copy:
    dest: "{{ onlyoffice_home }}/.env"
    content: |
      ONLYOFFICE_PORT={{ onlyoffice_port }}
      ONLYOFFICE_VERSION={{ onlyoffice_version }}

- name: Build and start
  docker_compose:
    project_src: "{{ onlyoffice_home }}"
    build: yes
    state: present
    restarted: yes
