- name: Create user
  user:
    name: "{{ onlyoffice_user }}"
    state: present
    create_home: yes
    home: "{{ onlyoffice_home }}"
  register: _user

- name: Create volumes
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ _user.uid }}"
    group: "{{ _user.group }}"
  loop:
    - "{{ onlyoffice_volume_logs }}"

- name: Create build directory
  file:
    path: "{{ onlyoffice_build_dir }}"
    state: directory
    mode: o-r
  register: _build

- name: Copy build files
  template:
    dest: "{{ _build.path }}"
    src: "{{ item }}"
  loop:
    - Dockerfile
    - reject_unauthorized.diff

- name: Copy ICOS fonts
  copy:
    src: droidserif.rar
    dest: "{{ _build.path }}"

- name: Copy runtime files
  template:
    src: "{{ item.name }}"
    dest: "{{ _user.home }}"
    mode: "{{ item.mode | default(omit) }}"
  loop:
    - { name: docker-compose.yml }
    - { name: onlyoffice.env,
        mode: o-r }

- name: Build images using docker-compose
  shell: |
    ( echo -n '=== starting build '; date; docker-compose build ) \
    | tee -a build.log
  args:
    chdir: "{{ _user.home }}"
  register: _build
  changed_when: '" ---> Running in " in _build.stdout'

- include_role: name=icos.certbot

- name: Copy nginx config file
  template:
    src: onlyoffice.conf
    dest: /etc/nginx/conf.d/
  notify: reload nginx config

- debug:
    msg: |
      Don't forget to manually restart onlyoffice.
