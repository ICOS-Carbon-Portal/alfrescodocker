- name: Install golang
  import_role:
    name: icos.golang

# These are straight out of the podman documentation.
- name: Install podman requirements
  apt:
    name:
      - btrfs-progs
      - git
      - go-md2man
      - iptables
      - libassuan-dev
      - libbtrfs-dev
      - libc6-dev
      - libdevmapper-dev
      - libglib2.0-dev
      - libgpgme-dev
      - libgpg-error-dev
      - libprotobuf-dev
      - libprotobuf-c-dev
      - libseccomp-dev
      - libselinux1-dev
      - libsystemd-dev
      - pkg-config
      # crun is smaller than runc
      - crun
      - uidmap

# ansible_kernel == $(uname -r) == 5.15.0-30-generic
- name: Assert that user namespaces are available
  command: grep -q CONFIG_USER_NS=y /boot/config-{{ ansible_kernel }}
  changed_when: false

# https://podman.io/getting-started/installation.html
- name: Clone podman
  git:
    repo: https://github.com/containers/podman
    version: "v{{ podman_version }}"
    dest: "{{ podman_src_dir }}"

- name: Build podman
  make:
    chdir: "{{ podman_src_dir }}"
    target: default
    params:
      BUILDTAGS: "seccomp selinux systemd"

- name: Install podman
  make:
    chdir: "{{ podman_src_dir }}"
    target: install

- name: Install cni_plugins
  import_role:
    name: icos.cni_plugins
