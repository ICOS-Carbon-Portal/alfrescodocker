- name: Install postgresql and postgis
  include_role:
    name: icos.postgresql
    public: yes
    apply:
      tags: postgresql
  tags: postgresql
  vars:
    postgresql_postgis_enable: true

# We install bbclient even when backup is disabled, in order to retrieve backup
# data which is useful when istalling in staging.
- name: Install bbclient
  tags: postgis_bbclient
  include_role:
    name: icos.bbclient2
    public: yes
    apply:
      tags: postgis_bbclient
  vars:
    bbclient_name: "{{ postgis_bbclient_name }}"
    bbclient_user: postgres
    bbclient_home: "{{ postgresql_home }}/.bbclient"

- import_tasks: backup.yml
  tags: postgis_backup

- name: Stop here
  meta: end_play

# - name: Allow postgres user to connect from same subnet
#   tags: hba
#   postgresql_pg_hba:
#     dest: "{{ postgresql_hba_file }}"
#     users: postgres
#     source: samenet
#     method: md5
#     contype: hostssl

# Switch to postgres so we use socket authentication.
- become: true
  become_user: postgres
  tags: cplog
  block:
    - name: Create postgres cplog users
      postgresql_user:
        db: cplog
        name: "{{ item.username }}"
        password: "{{ item.password }}"
      loop: "{{ vault_postgis_cplog_users }}"

    - name: Allow users to connect from same subnet
      postgresql_pg_hba:
        dest: "{{ postgresql_hba_file }}"
        users: "{{ item.username }}"
        source: samenet
        method: md5
        contype: hostssl
      loop: "{{ vault_postgis_cplog_users }}"

    - name: Add the pg_stat_statements extension
      community.postgresql.postgresql_ext:
        name: pg_stat_statements
        db: cplog
        schema: public
