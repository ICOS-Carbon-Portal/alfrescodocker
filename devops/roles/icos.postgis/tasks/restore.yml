- name: Get filename of latest borg backup
  ansible.builtin.shell:
    cmd: borg list --short {{ corebackup_host }}:{{ postgis_backup_location }} | tail -1
  register: postgis_last_backup

- debug: var=postgis_last_backup.stdout

- name: Extract backup
  ansible.builtin.shell:
    cmd: borg extract --stdout {{ corebackup_host }}:{{ postgis_backup_location }}::{{ postgis_last_backup.stdout }} | egrep -v '^(CREATE|ALTER) ROLE' | docker exec -i {{ postgis_container_name }} psql -U postgres > roles/icos.postgis/postgis_restore_log.txt

- debug: msg="Backup restore done. Log can be found in roles/icos.postgis/postgis_restore_log.txt"
