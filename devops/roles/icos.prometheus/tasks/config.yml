- name: Copy prometheus config
  tags: prometheus_config
  copy:
    src: "{{ prometheus_prom_cf }}"
    dest: "{{ prometheus_home }}/volumes/prometheus_conf/prometheus.yml"
    validate: promtool check config %s
  notify: reload prom config

- name: Copy blackbox config
  tags: prometheus_config
  copy:
    src: "{{ prometheus_bbox_cf }}"
    dest: "{{ prometheus_home }}/volumes/blackbox_conf/blackbox.yml"
    validate: blackbox_exporter --config.check --config.file %s
  notify: reload bbox config

- name: Copy alertmanager config
  tags: prometheus_config
  template:
    src: "{{ prometheus_alrt_cf }}"
    dest: "{{ prometheus_home }}/volumes/alertmanager_conf/config.yml"
    validate: amtool check-config %s
  notify: reload alrt config
  when: prometheus_alrt_cf

- name: Copy grafana config
  tags: grafana_config
  template:
    src: "{{ prometheus_graf_cf }}"
    dest: "{{ prometheus_home }}/volumes/grafana_conf/grafana.ini"
  notify: restart grafana
  when: prometheus_graf_cf

# Prometheus will dynamically re-read these files.
- name: Synchronize source
  ansible.posix.synchronize:
    src: "{{ prometheus_prom_dynamic }}"
    dest: "{{ prometheus_home }}/volumes/prometheus_conf/"
    delete: yes
  notify:
    - reload prom config
  
