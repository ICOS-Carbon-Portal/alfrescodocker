- name: Install rsync
  apt:
    name:
      - rsync

- name: Add config block to /etc/rsyncd.conf
  copy:
    dest: /etc/rsyncd.conf
    content: "{{ rsyncd_conf }}"
  notify: restart rsync

- name: Make sure that /etc/rsyncd.secrets exists
  lineinfile:
    path: /etc/rsyncd.secrets
    mode: 0600
    line: "# this file is partly generated by ansible"
    create: true
    insertbefore: BOF

- name: Start rsync service
  systemd:
    name: rsync
    enabled: "{{ rsyncd_enable }}"
    state: "{{ 'started' if rsyncd_enable else 'stopped' }}"

- name: Copy justfile
  template:
    src: ops-rsyncd
    dest: /usr/local/bin/
    mode: +x
    variable_start_string: "(("
    variable_end_string: "))"
    lstrip_blocks: yes
  register: _justfile

- name: Check that the justfile is executable
  shell: "{{ _justfile.dest }}"
  changed_when: no
