- name: Download script_exporter
  include_role:
    name: icos.github_download_bin
  vars:
    dbin_user: ricoberger
    dbin_repo: script_exporter
    # https://github.com/ricoberger/script_exporter/releases/download/v2.12.0/script_exporter-linux-amd64
    dbin_url: "{{ dbin__down }}/v{{ dbin__vers }}/script_exporter-linux-{{ sexp_arch }}"
    dbin_download_dest: "{{ dbin_download_base }}/script-exporter-{{ dbin__vers }}"
    dbin_unar: false

- name: Create script_exporter home directory
  file:
    path: "{{ sexp_config_d }}"
    state: directory

# We'll assemble script-exporter's config.yaml out of fragments; this is the
# first fragment.
- name: Create script_exporter prefix config fragment
  copy:
    dest: "{{ sexp_config_d }}/1_main.yml"
    content: |
      # This file is constructed by ansible out of fragments found in
      # {{ sexp_config_d }}

      # This needs to be here for HTTP discovery to be enabled.
      discovery:

      # Add just the top-level 'scripts' label. It will then be populated by
      # individual fragments.
      scripts:

- name: Assemble script_exporter config file
  assemble:
    src: "{{ sexp_config_d }}"
    dest: "{{ sexp_config_f }}"
  register: _conf

- name: Copy script-exporter systemd files
  template:
    dest: /etc/systemd/system/
    src: script-exporter.service
  register: _sysd

- name: Start/restart script-exporter.service
  systemd:
    daemon-reload: "{{ 'yes' if _sysd.changed else 'no' }}"
    name: script-exporter.service
    enabled: yes
    state: "{{ 'restarted' if _sysd.changed or _conf.changed else 'started' }}"

- import_tasks: exporters.yml
  tags: script_exporter_exporters
