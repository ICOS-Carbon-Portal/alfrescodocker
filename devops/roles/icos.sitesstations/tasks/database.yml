- name: Copy database dump
  copy:
    src: application_sites.sql
    dest: "{{ project_dir }}/db/"

- name: Copy database conf file
  template:
    src: station-form-mysql.conf.j2
    dest: "{{ project_dir }}/db/station-form-mysql.conf"
  register: database_conf

- name: Move database conf file
  command: 'docker exec stationform_mysql_1 cp /var/lib/mysql/station-form-mysql.conf ~/.my.cnf'
  when: database_conf.changed

- name: Restore database
  shell:
    >
    docker exec -i stationform_mysql_1 sh -c
    'mysql -e "DROP DATABASE IF EXISTS application_sites"
    && mysql -e "CREATE DATABASE application_sites"
    && mysql application_sites < /var/lib/mysql/application_sites.sql'
  # mysql is not always ready to accept connections the first time
  register: result
  until: result.stderr == ""
  retries: 3
  delay: 5
