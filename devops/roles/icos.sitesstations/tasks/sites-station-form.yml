---
- include_vars:
    file: vars/{{ ansible_distribution }}.yml

- name: Copy nginx conf
  copy:
    src: sitesdata.conf
    dest: /etc/nginx/conf.d/
    mode: 0700
  notify: reload nginx config

- name: Get SSL certificate
  import_tasks: ssl-certificate.yml
  when: get_ssl

- name: Add sites user
  user:
    name: sites
    append: yes

- name: Create project directory
  file:
    path: {{ project_dir }}
    state: directory

- import_tasks: sites.yml
  become_user: sites

- name: Copy Dockerfile
  copy:
    src: Dockerfile
    dest: {{ project_dir }}/

- name: Copy docker-compose.yml
  template:
    src: docker-compose.yml.j2
    dest: {{ project_dir }}/docker-compose.yml

- name: Run docker-compose
  docker_service:
    project_src: {{ project_dir }}
    state: present

- name: Restore database
  import_tasks: database.yml
  when: restore
