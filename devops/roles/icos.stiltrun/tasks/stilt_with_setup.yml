- name: List docker images
  command: docker images -qa
  register: docker_images
  changed_when: False

- block:
    - name: Set image tmp name
      set_fact: stilt_with_setup_tmp_fname="/tmp/{{ stilt_with_setup_url | basename }}"
      changed_when: false
    - name: Download image
      get_url:
        url: "{{ stilt_with_setup_url }}"
        dest: "{{ stilt_with_setup_tmp_fname }}"
    - name: Load stilt_with_setup into docker
      command: docker load -i "{{ stilt_with_setup_tmp_fname }}"
    - name: Check that stilt_with_setup was properly loaded
      shell: docker images -q | grep {{ stilt_with_setup_imageid }} -q
  when: stilt_with_setup_imageid not in docker_images.stdout

- name: Install the stilt python wrapper
  become: True
  become_user: root
  copy:
    src: stilt.py
    # /usr/local/bin is per default in the PATH of systemd services, which is
    # important since stiltweb runs as a systemd service (and stiltweb is the
    # main user of the stilt python wrapper).
    dest: /usr/local/bin/stilt
    mode: 0755

- name: Do a test of the stiltrun installation
  # Note that we have to use the full path since /usr/local/bin _isn't_ in the
  # PATH used by ansible's shell module.
  shell: /usr/local/bin/stilt calcslots 2012010100 2012010106
  register: stilt_output

- name: Check the output of the testrun
  assert:
    that: stilt_output.stdout == "2012010100\n2012010103\n2012010106"

