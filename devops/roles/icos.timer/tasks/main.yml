- name: Create home directory
  when: timer_home is defined
  file:
    path: "{{ timer_home }}"
    state: directory

- name: Create timer script
  copy:
    dest: "{{ timer_dest }}"
    mode: +x
    content: "{{ timer_content }}"
  when: timer_content is defined

- name: Create systemd timer definition
  copy:
    dest: "{{ _timer_sysd_timer }}"
    content: |
      [Unit]
      Description={{ timer_name }}

      [Timer]
      {{ timer_conf }}

      [Install]
      WantedBy=timers.target

- name: Create systemd service
  copy:
    dest: "{{ _timer_sysd_service }}"
    content: |
      [Unit]
      Description={{ timer_name }}

      [Service]
      User={{ timer_user }}
      Type=oneshot
      ExecStart={{ timer_exec }}
      {% for env in timer_envs | default([]) -%}
      Environment={{ env }}
      {% endfor -%}

- name: Link systemd files
  command:  systemctl link {{ _timer_sysd_timer }} {{ _timer_sysd_service }}
  register: _r
  failed_when: _r.rc != 0
  changed_when: '"Created" in _r.stdout'

- name: Start timer
  systemd:
    name: "{{ timer_name }}.timer"
    enabled: yes
    state: started
    daemon_reload: yes
