# https://grafana.com/docs/grafana/latest/administration/plugin-management/#install-grafana-plugins
# https://github.com/VictoriaMetrics/grafana-datasource
# https://grafana.com/docs/grafana/latest/setup-grafana/configure-grafana/#plugins-1

- name: Create grafana plugin directory
  file:
    path: "{{ vm_graf_plugins }}"
    state: directory

- name: Find the latest release of grafana-datasource
  run_once: true
  delegate_to: localhost
  check_mode: false
  github_release:
    user: VictoriaMetrics
    repo: grafana-datasource
    action: latest_release
  register: release

- name: Download grafana-datasource
  ansible.builtin.get_url:
    url: "https://github.com/VictoriaMetrics/grafana-datasource/releases/download/{{ release.tag }}/victoriametrics-datasource-{{ release.tag }}.zip"
    dest: "/tmp"
  register: url

- name: Unarchive victoriametrics-datasource.zip
  unarchive:
    src: "{{ url.dest }}"
    dest: "{{ vm_graf_plugins }}"
    remote_src: true
  diff: false
