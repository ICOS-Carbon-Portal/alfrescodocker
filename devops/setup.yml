---
# Version check play.
- hosts: all
  tags: setup
  gather_facts: no
  pre_tasks:
    # Use fail since assert is to verbose.
    # https://github.com/ansible/ansible/issues/27124
     - name: Fail if ansible is too old
       fail:
        msg: "This playbook uses features that requires ansible >= 2.4"
       when: "ansible_version.full is version_compare('2.4', '<=')"

- hosts: all
  tags: always
  gather_facts: no
  pre_tasks:
    - name: Ensure infrastructure repo is up to date
      local_action: shell git fetch && git rev-list HEAD...origin/master --count
      register: git_result
      changed_when: false
      when: check_infrastructure_version|default(true)

    - name: Fail if infrastructure is outdated
      fail:
        msg: "Your local infrastructure is outdated! Pull the new commits from origin/master."
      when: check_infrastructure_version|default(true) and git_result.stdout|int > 0

# Include local_vars.yml if it exist but don't fail if it doesn't.
# That file is meant for local variables (not checked into git).
- hosts: all
  tags: always
  gather_facts: no
  pre_tasks:
    - include_vars: "{{ item }}"
      with_first_found:
        - local_vars.yml
        - /dev/null

# The system that is being provisioned needs to have python installed. Of the
# two systems we currently support, CentOS 7 and Ubuntu 16.04, only CentOS have
# python installed out of the box. This play will attempt to blindly install
# python on Ubuntu. The play needs to have gather_facts turned off, because
# gather_facts requires python to be already installed.
- hosts: all
  tags: setup
  become: true
  become_user: root
  gather_facts: no
  pre_tasks:
    - name: Install python (as required by ansible)
      # http://docs.ansible.com/ansible/intro_installation.html
      raw: "test -e /usr/bin/python || apt install -y python-minimal"
      register: raw_python
      changed_when: '"Setting up python" in raw_python.stdout'
