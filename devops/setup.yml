# Version check play.
- hosts: localhost
  tags: always
  gather_facts: no
  pre_tasks:
     - name: Fail if ansible is too old
       fail:
        msg: |
          This playbook uses features that requires ansible >= 4.7.
          Please upgrade your version of ansible, to do this, first run:
            pip3 install --user ansible==q
          Then find the latest version from the output and then run:
            pip3 install --user ansible==4.7
       # Ansible 3 started separating the ansible version from the versions of
       # ansible.core (which is what is reported by ansible_version.full).
       when: ansible_version.full is version('2.11.6', '<')

- hosts: localhost
  tags: always
  gather_facts: no
  pre_tasks:
    - name: Ensure infrastructure repo is up to date
      delegate_to: localhost
      # --count will return the number of commits that would have been
      # listed. Either local unpushed commits or remote unmerged commits.
      shell: git fetch && git rev-list HEAD...origin/master --count
      register: git_result
      changed_when: false
      # The extra '|bool' is to allow the setting to be passed with '-echeck...'
      when: check_infrastructure_version|default(true)|bool

    - name: Fail if infrastructure is outdated
      fail:
        msg: "Your infrastructure repo is not in sync with origin. Pull/push origin/master."
      when: check_infrastructure_version|default(true)|bool and git_result.stdout|int > 0
