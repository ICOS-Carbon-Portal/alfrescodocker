# This ansible playbook will provision the STILT servers.

---
- import_playbook: setup.yml

# This play just serves to establish an ssh connection to each of the cluster
# hosts, this collecting the host's ssh key, which we then need in the
# stiltmaster play in order to set up known_hosts.
- hosts: stiltcluster
  tasks:
    - debug: msg="Collecting host key from {{ inventory_hostname }}"

- hosts: stiltmaster
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.stiltweb
      tags: stiltweb
    - role: icos.stiltrun
      tags: stiltrun
    - role: icos.stiltcluster
      tags: stiltcluster


- hosts: stiltcluster
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.stiltrun
      tags: stiltrun
    - role: icos.stiltcluster
      tags: stiltcluster


# EXPORT STILTWEB DATA FROM FSICOS1 TO FSICOS2
# FIXME: Make this run with test.inventory.

- hosts: icosprod2
  become: true
  tasks:
    - block:
        - name: Install nfs server
          package:
            name: nfs-kernel-server
            state: present

        - name: Modify exports file
          copy:
            dest: /etc/exports
            content: |
              /disk/data/stiltweb	194.47.223.133(ro)
              /disk/data/stilt      194.47.223.133(ro)
          register: _exports

        - name: Reload NFS server
          service: name=nfs-server state=reloaded enabled=yes
          when: _exports.changed

        - name: Completely open firewall
          ufw:
            rule: allow
            src: "194.47.223.133"
      tags:
        - stilt_export

- hosts: icosprod
  become: true
  tasks:
    - name: Create stiltweb mountpoint
      file: path="/disk/data/STILT/fsicos2/stiltweb" state=directory

    - name: Mount stiltweb data from fsicos2
      mount:
        path: "/disk/data/STILT/fsicos2/stiltweb"
        src: "fsicos2.lunarc.lu.se:/disk/data/stiltweb"
        fstype: nfs
        opts: ro
        state: mounted
      tags:
        - stilt_export

    - name: Create stilt mountpoint
      file: path="/disk/data/STILT/fsicos2/stilt" state=directory

    - name: Mount stilt data from fsicos2
      mount:
        path: "/disk/data/STILT/fsicos2/stilt"
        src: "fsicos2.lunarc.lu.se:/disk/data/stilt"
        fstype: nfs
        opts: ro
        state: mounted
      tags:
        - stilt_export
