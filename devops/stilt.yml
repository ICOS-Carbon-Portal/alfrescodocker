# This ansible playbook will provision the STILT servers.

---
- import_playbook: setup.yml

# This play just serves to establish an ssh connection to each of the cluster
# hosts, thus collecting the host's ssh key, which we then need in the
# stiltmaster play in order to set up known_hosts.
- hosts: stiltcluster
  tasks:
    - debug: msg="Collecting host key from {{ inventory_hostname }}"

- hosts: stiltmaster
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.stiltweb
      tags: stiltweb
    - role: icos.stiltrun
      tags: stiltrun
    - role: icos.stiltcluster
      tags: stiltcluster

- hosts: stiltcluster
  become: true
  vars_files:
    - vault.yml
    - vars.yml
  roles:
    - role: icos.stiltrun
      tags: stiltrun
    - role: icos.stiltcluster
      tags: stiltcluster


# EXPORT STILTWEB DATA FROM FSICOS2 TO FSICOS1

- hosts: icosprod2
  become: true
  tasks:
    - name: Export stiltdata to icosprod1
      tags: stilt_export
      block:
        - name: Install nfs server
          package:  name=nfs-kernel-server  state=present

        - name: Modify exports file
          copy: dest=/etc/exports  content="{{ stilt_nfs_exports }}"
          register: _exports

        - name: Reload NFS server
          service: name=nfs-server state=reloaded enabled=yes
          when: _exports.changed

        - name: Completely open firewall to {{ stilt_nfs_icosprod1_ip }}
          ufw: rule=allow src="{{ stilt_nfs_icosprod1_ip }}"

- hosts: icosprod
  become: true
  vars:
  tasks:
    - name: Mount stiltdata from icosprod2
      tags: stilt_export
      block:
        - name: Create mountpoint {{ item.path }}
          file: path="{{ item.path }}" state=directory
          loop: "{{ stilt_nfs_mounts }}"

        - name: Mount "{{ item.path }}" from icosprod2
          loop: "{{ stilt_nfs_mounts }}"
          mount:
            path: "{{ item.path }}"
            src: "{{ item.src }}"
            fstype: nfs
            opts: ro
            state: mounted
