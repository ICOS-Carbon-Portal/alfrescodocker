# Install the cpauth software, compile it and start it as a systemd service.
- name: Add cpauth user
  user:
    name: cpauth

- name: Clone cpauth
  become_user: cpauth
  git:
    repo: https://github.com/ICOS-Carbon-Portal/cpauth.git
    dest: /home/cpauth/cpauth
  notify: compile cpauth
    
- name: compile cpauth
  become_user: cpauth
  command: sbt assembly chdir=/home/cpauth/cpauth
  notify: restart cpauth
  # - creates: "/home/cpauth/cpauth/target/scala-2.11/Carbon Portal Authentication Service-assembly-0.4.jar"
  
# This solves "Exception in thread "main" spray.json.DeserializationException:
# Object is missing required member 'clientId'"
- name: Install application.conf
  copy: src=application.conf dest=/home/cpauth/cpauth/ owner=cpauth group=cpauth mode=0644
  notify: restart cpauth
  
# This solves "Exception in thread "main" java.lang.IllegalArgumentException:
# InputStream cannot be null"
- name: Copy xml config
  copy: src=/home/andre/icos/cpauth/src/main/resources/swamid-idps.xml dest=/home/cpauth/cpauth/src/main/resources owner=cpauth group=cpauth mode=0644
  notify: restart cpauth
  
- name: Add systemd service
  copy: src=cpauth.service dest=/etc/systemd/system/ owner=cpauth group=cpauth mode=0644
  notify: reload systemd config

- name: Enable and start cpauth service
  service: name=cpauth state=started enabled=yes
