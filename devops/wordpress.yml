- hosts: fsicos2.lunarc.lu.se
  vars:
    wordpress_domains:
      - www.ingos-infrastructure.eu
      - www.eric-forum.eu
      - www.icos-summerschool.eu
      - www.envriplus.eu
  roles:
    - name: Create the wordpress VM
      tags: lxd
      role: icos.lxd_vm
      vars:
        lxd_vm_name: wordpress
        lxd_vm_root_size: "500GB"
        lxd_vm_config:
          limits.cpu: "4"
          limits.memory: "8GB"
  tasks:
    - name: Create certificate
      tags: cert
      include_role:
        name: icos.certbot2
      vars:
        certbot_name: wordpress
        certbot_domains: "{{ wordpress_domains }}"

    - name: Install nginx configuration
      tags: nginx
      include_role:
        name: icos.nginxsite
      vars:
        nginxsite_name: wordpress
        nginxsite_file: files/wordpress.conf


- hosts: wordpress
  vars:
    lxd_guest_root_keys: "{{ vault_wordpress_root_keys }}"
  tasks:
    - import_role: name=icos.lxd_guest
      tags: guest

    - debug:
        msg: |
          # Don't forget to add the following in your wp-config.php, after the
          # WP_DEBUG line. Otherwise you'll get redirect loops.
          if ( $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https' )
          {
              $_SERVER['HTTPS']       = 'on';
              $_SERVER['SERVER_PORT'] = 443;
          }
