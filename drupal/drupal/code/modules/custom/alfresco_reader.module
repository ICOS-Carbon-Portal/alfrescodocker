<?php


function alfresco_reader_block_info() {
	$blocks = array();
	
	$blocks['alfresco_reader'] = array(
			'info' => t('Alfresco reader'),
	);

	return $blocks;
}


function alfresco_reader_block_view($delta = '') {

	if ($delta == 'alfresco_reader') {

		$folderIdList = array();
		$objectIdList = '';
		if (variable_get('alfresco_reader_objectid_list')) {
			$folderIdList = explode(',', variable_get('alfresco_reader_objectid_list'));
		}
		
		$formatted = '';
		
		foreach ($folderIdList as $folderId) {
			$id = trim($folderId);
			if (! empty($id)) {
				$properties = _alfresco_reader_get_cmis_object_properties($id);
				$contents = _alfresco_reader_get_cmis_sub_objects($id);
				$formatted .= _alfresco_reader_build_output($properties, $contents);
			}
		}
 
		$block = array(
			'subject' => t(''),
			'content' => array(
				'#markup' => t($formatted),
				'#attached' => array(
					'css' => array('https://static.icos-cp.eu/constant/bootstrap/3.3.4/css/bootstrap.min.css', drupal_get_path('module', 'alfresco_reader') . '/alfresco_reader.css'),
					'js' => array('https://static.icos-cp.eu/constant/jquery/1.11.2/jquery.min.js', 'https://static.icos-cp.eu/constant/bootstrap/3.3.4/js/bootstrap.min.js', drupal_get_path('module', 'alfresco_reader') . '/alfresco_reader.js'),
				),
			),
		);
		
		return $block;
	}

}


function _alfresco_reader_build_output($properties, $contents) {

	$output = '<div id="accordion_' . $properties->properties['cmis:objectId'] . '" class="alfresco_reader panel-group" role="tablist" aria-multiselectable="true">';
	
	$output .= '<div class="panel panel-primary">';
	
	$output .= '<div id="heading_' . $properties->properties['cmis:objectId'] .'" class="panel-heading" role="tab">';	
	$output .= '<h3 class="panel-title">';
	$output .= '<a role="button" data-toggle="collapse" data-parent="#accordion_' . $properties->properties['cmis:objectId'] . '" href="#collapse_'. $properties->properties['cmis:objectId'] . '" aria-expanded="true" aria-controls="collapse_' . $properties->properties['cmis:objectId'] . '">';
	$output .= $properties->properties['cmis:name'];
	$output .= '</a>';
	$output .= '</h3>';
	$output .= '</div>';
	
	$output .= '<div id="collapse_' . $properties->properties['cmis:objectId'] . '" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading_' . $properties->properties['cmis:objectId'] . '">';

	$output .= '<div class="panel-body">';

	$output .= '<table class="table table-hover table-responsive">';

	foreach ($contents as $content) {
		if ($content->properties['cmis:baseTypeId'] != 'cmis:folder') {
			$document = trim($content->properties['cmis:name']);
			$document = str_replace('_', ' ', $document);

			$modifiedBy = $content->properties['cmis:lastModifiedBy'];
			$modifiedBy = str_replace('.', ' ', $modifiedBy );

			$modificationDate = new DateTime($content->properties['cmis:lastModificationDate']);

			$output .= '<tr>';
			$output .= '<td>';
			
			$output .= l($document, 'cmis/browser', array('query' => array('id' => $content->properties['cmis:objectId'])));
			$output .= '<br/>';
			$output .= '<span class="small_text">' . $modifiedBy . '  ' . $modificationDate->format('Y-m-d H:i') . '</span>';
			
			$output .= '</td>';
			$output .= '</tr>';
		}		
	}	
	
	$output .= '</table>';
	
	$output .= '</div>';
	$output .= '</div>';
	$output .= '</div>';
	$output .= '</div>';
	
	return $output;
}


function _alfresco_reader_get_cmis_object_properties($objectId) {
	module_load_include('api.inc', 'cmis');
	
	try {
		$repository = cmisapi_getRepositoryInfo();
		$properties = cmisapi_getProperties($repository->repositoryId, $objectId);

		return $properties;		

	} catch (CMISException $e) {
		cmis_error_handler('cmis_query', $e);
	}	
}


function _alfresco_reader_get_cmis_sub_objects($objectId) {
	module_load_include('api.inc', 'cmis');

	try {
		$repository = cmisapi_getRepositoryInfo();
		$repoId = !empty ($repository->repositoryId) ? $repository->repositoryId : 'default';	
		$objects = cmisapi_getChildren($repoId, $objectId)->objectList;

		return $objects;
		
	} catch (CMISException $e) {
		cmis_error_handler('cmis_query', $e);
	}		
}


function alfresco_reader_menu() {
	$items = array();

	$items['admin/config/content/alfresco_reader'] = array(
			'title' => 'Alfresco reader configuration',
			'description' => 'Configuration for Alfresco reader',
			'page callback' => 'drupal_get_form',
			'page arguments' => array('_alfresco_reader_form'),
			'access arguments' => array('access administration pages'),
			'type' => MENU_NORMAL_ITEM,
	);

	return $items;
}


function _alfresco_reader_form($form, &$form_state) {

	$objectIdList = '';
	if (variable_get('alfresco_reader_objectid_list')) {
		$objectIdList = variable_get('alfresco_reader_objectid_list');
	}
	
	$form['alfresco_reader_objectid_list'] = array(
			'#type' => 'textarea',
			'#title' => t('Assign a comma separated list of folder id\'s.'),
			'#description' => t('Insert a comma separated list of id\'s of the Alfresco folders you want to list contents from.<br/>If there are some issues you will be noticed when you display the page.'),
			'#required' => FALSE,
			'#default_value' => $objectIdList,
	);

	return system_settings_form($form);
}
