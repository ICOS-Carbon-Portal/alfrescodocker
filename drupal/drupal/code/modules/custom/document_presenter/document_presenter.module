<?php


function document_presenter_block_info() {
	$blocks = array();
	
	$blocks['document_presenter'] = array(
			'info' => t('Document presenter'),
	);

	return $blocks;
}


function document_presenter_block_view($delta = '') {

	if ($delta == 'document_presenter') {
	
		$block = array(
			'subject' => t(''),
			'content' => array(
				'#markup' => t(_document_presenter_output()),
				'#attached' => array(
					'css' => array(drupal_get_path('module', 'document_presenter') . '/document_presenter.css', drupal_get_path('module', 'document_presenter') . '/three-columns.css'),
					'js' => array(drupal_get_path('module', 'document_presenter') . '/document_presenter.js'),
				),
			),
		);
		
		return $block;	
	}
}

function document_presenter_menu() {
	$items = array();

	$items['admin/config/content/document_presenter'] = array(
		'title' => 'Document presenter configuration',
		'description' => 'Configuration for Document presenter',
		'page callback' => 'drupal_get_form',
		'page arguments' => array('_document_presenter_form'),
		'access arguments' => array('access administration pages'),
		'type' => MENU_NORMAL_ITEM,
	);

	return $items;
}


function _document_presenter_form($form, &$form_state) {
	$options = array();

	$list = _document_presenter_options();
	foreach ($list as $key => $value) {
		$options[$value['path']] = t($value['name']);
	}


	/**
	 * document category 1
	 */
	$checked_1 = array();
	foreach (variable_get('document_presenter_object_list_1') as $key => $value) {
		if ($value) {
			$checked_1[] = $value;
		}
	}

	$form['document_presenter_1'] = array(
		'#type' => 'fieldset',
		'#title' => t(_document_categories(1)),
		'#description' => t('Mark or unmark the documents you want to add/remove for the ' . _document_categories(1) . ' and then click on the button to save.<br/><br/>'),
		'#collapsible' => true,
		'#collapsed' => false,
	);

	$form['document_presenter_1']['document_presenter_object_list_1'] = array(
		'#type' => 'checkboxes',
		'#description' => t(''),
		'#options' => $options,
		'#default_value' => $checked_1,
	);


	/**
	 * document category 2
	 */
	$checked_2 = array();
	foreach (variable_get('document_presenter_object_list_2') as $key => $value) {
		if ($value) {
			$checked_2[] = $value;
		}
	}

	$form['document_presenter_2'] = array(
		'#type' => 'fieldset',
		'#title' => t(_document_categories(2)),
		'#description' => t('Mark or unmark the documents you want to add/remove for the ' . _document_categories(2) . ' and then click on the button to save.<br/><br/>'),
		'#collapsible' => true,
		'#collapsed' => false,
	);

	$form['document_presenter_2']['document_presenter_object_list_2'] = array(
		'#type' => 'checkboxes',
		'#description' => t(''),
		'#options' => $options,
		'#default_value' => $checked_2,
	);


	/**
	 * document category 3
	 */
	$checked_3 = array();
	foreach (variable_get('document_presenter_object_list_3') as $key => $value) {
		if ($value) {
			$checked_3[] = $value;
		}
	}

	$form['document_presenter_3'] = array(
		'#type' => 'fieldset',
		'#title' => t(_document_categories(3)),
		'#description' => t('Mark or unmark the documents you want to add/remove for the ' . _document_categories(3) . ' and then click on the button to save.<br/><br/>'),
		'#collapsible' => true,
		'#collapsed' => false,
	);

	$form['document_presenter_3']['document_presenter_object_list_3'] = array(
		'#type' => 'checkboxes',
		'#description' => t(''),
		'#options' => $options,
		'#default_value' => $checked_3,
	);


	/**
	 * document category 4
	 */
	$checked_4 = array();
	foreach (variable_get('document_presenter_object_list_4') as $key => $value) {
		if ($value) {
			$checked_4[] = $value;
		}
	}

	$form['document_presenter_4'] = array(
		'#type' => 'fieldset',
		'#title' => t(_document_categories(4)),
		'#description' => t('Mark or unmark the documents you want to add/remove for the ' . _document_categories(4) . ' and then click on the button to save.<br/><br/>'),
		'#collapsible' => true,
		'#collapsed' => false,
	);

	$form['document_presenter_4']['document_presenter_object_list_4'] = array(
		'#type' => 'checkboxes',
		'#description' => t(''),
		'#options' => $options,
		'#default_value' => $checked_4,
	);


	/**
	 * document category 5
	 */
	$checked_5 = array();
	foreach (variable_get('document_presenter_object_list_5') as $key => $value) {
		if ($value) {
			$checked_5[] = $value;
		}
	}

	$form['document_presenter_5'] = array(
		'#type' => 'fieldset',
		'#title' => t(_document_categories(5)),
		'#description' => t('Mark or unmark the documents you want to add/remove for the ' . _document_categories(5) . ' and then click on the button to save.<br/><br/>'),
		'#collapsible' => true,
		'#collapsed' => false,
	);

	$form['document_presenter_5']['document_presenter_object_list_5'] = array(
		'#type' => 'checkboxes',
		'#description' => t(''),
		'#options' => $options,
		'#default_value' => $checked_5,
	);


	return system_settings_form($form);
}


function _document_categories($index) {
	$names = array(1 => 'NEWSLETTERS', 2 => 'PRESS RELEASES', 3 => 'BROCHURES & LOGOS', 4 => 'PUBLICATIONS', 5 => 'FROM THE PRESS');
	return $names[$index];
}


function _document_presenter_options() {
	$content = array();

	$folder = variable_get('file_public_path', conf_path() . '/files');

	foreach (scandir($folder) as $file) {

		if ((is_file($folder . '/' . $file) && (substr_compare($file, 'pdf', -3, 3, true) == 0))) {
			$content[] = array('name' => $file, 'path' => $file);
		}
	}

	return $content;
}


function _document_presenter_output() {

	$folder = variable_get('file_public_path', conf_path() . '/files');

	$title_color = '';
	if (variable_get('broscience_style_contents_title_color')) {
		$title_color = 'style="color: ' . variable_get('broscience_style_contents_title_color') . '"';
	}

	$element_color = '';
	if (variable_get('broscience_style_contents_element_color')) {
		$element_color = 'background-color: ' . variable_get('broscience_style_contents_element_color') . '; color: #ffffff;';
	}


	$output = '<h1 class="block_title" ' . $title_color . '>PRESS AND MEDIA</h1>';

	$output .= '<div id="document_presenter">';

	/**
	 * document category 1
	 */
	$list_1 = array();
	foreach (variable_get('document_presenter_object_list_1') as $key => $value) {
		if ($value && file_exists($folder . '/' .$value) && is_file($folder . '/' . $value)) {
			$list_1[] = _collect($value);
		}
	}

	if (! empty($list_1)) {

		usort($list_1, _compare);

		$output .= '<div id="document_presenter_accordion_1" class="document_presenter panel-group" role="tablist" aria-multiselectable="true">';
		$output .= '<div class="panel panel-default">';
		$output .= '<div id="document_presenter_accordion_1_heading" class="panel-heading" role="tab" style="' . $element_color . '">';
		$output .= '<h3 class="panel-title">';
		$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/icon_news.svg" />';
		$output .= '<a role="button" data-toggle="collapse" data-parent="#document_presenter_accordion_1" href="#document_presenter_accordion_1_collapse" aria-expanded="true" aria-controls="document_presenter_accordion_1_collapse">';
		$output .= _document_categories(1);
		$output .= '</a>';
		$output .= '</h3>';
		$output .= '</div>';
		$output .= '<div id="document_presenter_accordion_1_collapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="document_presenter_accordion_1_heading">';
		$output .= '<div class="panel-body">';

		foreach ($list_1 as $file) {
			$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/application-pdf.png" />';
			$output .= '<a href="' . $folder . '/' . $file['file_name'] . '" target="_blank">' . $file['file_name'] . '</a>';
			$output .= '<br />';
		}

		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
	}


	/**
	 * document category 2
	 */
	$list_2 = array();
	foreach (variable_get('document_presenter_object_list_2') as $key => $value) {
		if ($value && file_exists($folder . '/' .$value) && is_file($folder . '/' . $value)) {
			$list_2[] = _collect($value);
		}
	}

	if (! empty($list_2)) {

		usort($list_2, _compare);

		$output .= '<div id="document_presenter_accordion_2" class="document_presenter panel-group" role="tablist" aria-multiselectable="true">';
		$output .= '<div class="panel panel-default">';
		$output .= '<div id="document_presenter_accordion_2_heading" class="panel-heading" role="tab" style="' . $element_color . '">';
		$output .= '<h3 class="panel-title">';
		$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/icon_releases.svg" />';
		$output .= '<a role="button" data-toggle="collapse" data-parent="#document_presenter_accordion_2" href="#document_presenter_accordion_2_collapse" aria-expanded="true" aria-controls="document_presenter_accordion_2_collapse">';
		$output .= _document_categories(2);
		$output .= '</a>';
		$output .= '</h3>';
		$output .= '</div>';
		$output .= '<div id="document_presenter_accordion_2_collapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="document_presenter_accordion_2_heading">';
		$output .= '<div class="panel-body">';

		foreach ($list_2 as $file) {
			$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/application-pdf.png" />';
			$output .= '<a href="' . $folder . '/' . $file['file_name'] . '" target="_blank">' . $file['file_name'] . '</a>';
			$output .= '<br />';
		}

		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
	}


	/**
	 * document category 3
	 */
	$list_3 = array();
	foreach (variable_get('document_presenter_object_list_3') as $key => $value) {
		if ($value && file_exists($folder . '/' .$value) && is_file($folder . '/' . $value)) {
			$list_3[] = _collect($value);
		}
	}

	if (! empty($list_3)) {

		usort($list_3, _compare);

		$output .= '<div id="document_presenter_accordion_3" class="document_presenter panel-group" role="tablist" aria-multiselectable="true">';
		$output .= '<div class="panel panel-default">';
		$output .= '<div id="document_presenter_accordion_3_heading" class="panel-heading" role="tab" style="' . $element_color . '">';
		$output .= '<h3 class="panel-title">';
		$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/icon_brochures.svg" />';
		$output .= '<a role="button" data-toggle="collapse" data-parent="#document_presenter_accordion_1" href="#document_presenter_accordion_3_collapse" aria-expanded="true" aria-controls="document_presenter_accordion_3_collapse">';
		$output .= _document_categories(3);
		$output .= '</a>';
		$output .= '</h3>';
		$output .= '</div>';
		$output .= '<div id="document_presenter_accordion_3_collapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="document_presenter_accordion_3_heading">';
		$output .= '<div class="panel-body">';

		foreach ($list_3 as $file) {
			$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/application-pdf.png" />';
			$output .= '<a href="' . $folder . '/' . $file['file_name'] . '" target="_blank">' . $file['file_name'] . '</a>';
			$output .= '<br />';
		}

		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
	}


	/**
	 * document category 4
	 */
	$list_4 = array();
	foreach (variable_get('document_presenter_object_list_4') as $key => $value) {
		if ($value && file_exists($folder . '/' .$value) && is_file($folder . '/' . $value)) {
			$list_4[] = _collect($value);
		}
	}

	if (! empty($list_4)) {

		usort($list_4, _compare);

		$output .= '<div id="document_presenter_accordion_4" class="document_presenter panel-group" role="tablist" aria-multiselectable="true">';
		$output .= '<div class="panel panel-default">';
		$output .= '<div id="document_presenter_accordion_4_heading" class="panel-heading" role="tab" style="' . $element_color . '">';
		$output .= '<h3 class="panel-title">';
		$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/icon_publications.svg" />';
		$output .= '<a role="button" data-toggle="collapse" data-parent="#document_presenter_accordion_4" href="#document_presenter_accordion_4_collapse" aria-expanded="true" aria-controls="document_presenter_accordion_4_collapse">';
		$output .= _document_categories(4);
		$output .= '</a>';
		$output .= '</h3>';
		$output .= '</div>';
		$output .= '<div id="document_presenter_accordion_4_collapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="document_presenter_accordion_4_heading">';
		$output .= '<div class="panel-body">';

		foreach ($list_4 as $file) {
			$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/application-pdf.png" />';
			$output .= '<a href="' . $folder . '/' . $file['file_name'] . '" target="_blank">' . $file['file_name'] . '</a>';
			$output .= '<br />';
		}

		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
	}


	/**
	 * document category 5
	 */
	$list_5 = array();
	foreach (variable_get('document_presenter_object_list_5') as $key => $value) {
		if ($value && file_exists($folder . '/' .$value) && is_file($folder . '/' . $value)) {
			$list_5[] = _collect($value);
		}
	}

	if (! empty($list_5)) {

		usort($list_5, _compare);

		$output .= '<div id="document_presenter_accordion_5" class="document_presenter panel-group" role="tablist" aria-multiselectable="true">';
		$output .= '<div class="panel panel-default">';
		$output .= '<div id="document_presenter_accordion_5_heading" class="panel-heading" role="tab" style="' . $element_color . '">';
		$output .= '<h3 class="panel-title">';
		$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/icon_press.svg" />';
		$output .= '<a role="button" data-toggle="collapse" data-parent="#document_presenter_accordion_5" href="#document_presenter_accordion_5_collapse" aria-expanded="true" aria-controls="document_presenter_accordion_5_collapse">';
		$output .= _document_categories(5);
		$output .= '</a>';
		$output .= '</h3>';
		$output .= '</div>';
		$output .= '<div id="document_presenter_accordion_5_collapse" class="panel-collapse collapse" role="tabpanel" aria-labelledby="document_presenter_accordion_5_heading">';
		$output .= '<div class="panel-body">';

		foreach ($list_5 as $file) {
			$output .= '<img src="/' . drupal_get_path('module', 'document_presenter') . '/icons/application-pdf.png" />';
			$output .= '<a href="' . $folder . '/' . $file['file_name'] . '" target="_blank">' . $file['file_name'] . '</a>';
			$output .= '<br />';
		}

		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
		$output .= '</div>';
	}

	$output .= '</div>';

	return $output;
}


function _compare($a, $b) {
	if ($a['file_timestamp'] == $b['file_timestamp']) { return 0; }
	return ($a['file_timestamp'] > $b['file_timestamp']) ? -1 : 1;
}


function _collect($filename) {
	$list = [];
	$list['file_name'] =  $filename;

	$result = db_query('
		select fm.timestamp, fm.filesize
		from {file_managed} fm
		where fm.filename = :filename
		',

		array(':filename' => $filename)
	)->fetchAll();

	foreach ($result as $record) {
		if ($record) {
			$list['file_timestamp'] =  $record->timestamp;
			$list['file_size'] =  $record->filesize;
		}
	}

	return $list;
}


